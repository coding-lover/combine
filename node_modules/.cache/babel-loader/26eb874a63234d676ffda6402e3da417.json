{"remainingRequest":"/Users/zou/data/www/combine/node_modules/thread-loader/dist/cjs.js!/Users/zou/data/www/combine/node_modules/babel-loader/lib/index.js!/Users/zou/data/www/combine/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/zou/data/www/combine/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/zou/data/www/combine/src/components/page/Combine.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/zou/data/www/combine/src/components/page/Combine.vue","mtime":1698391803815},{"path":"/Users/zou/data/www/combine/babel.config.js","mtime":1698336527619},{"path":"/Users/zou/data/www/combine/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/zou/data/www/combine/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/zou/data/www/combine/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/Users/zou/data/www/combine/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/zou/data/www/combine/node_modules/vue-loader/lib/index.js","mtime":1655715099000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.regexp.to-string\";\nimport \"core-js/modules/es6.date.to-string\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.string.iterator\";\nimport _toConsumableArray from \"/Users/zou/data/www/combine/node_modules/@babel/runtime-corejs2/helpers/esm/toConsumableArray.js\";\nimport \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/es6.array.filter\";\nimport _typeof from \"/Users/zou/data/www/combine/node_modules/@babel/runtime-corejs2/helpers/esm/typeof.js\";\nimport \"core-js/modules/es6.regexp.constructor\";\nimport \"core-js/modules/es6.regexp.split\";\nimport \"core-js/modules/es6.array.last-index-of\";\nimport \"core-js/modules/es6.array.sort\";\nimport \"core-js/modules/es6.array.map\";\nimport \"core-js/modules/es6.array.index-of\";\nimport \"core-js/modules/es6.regexp.replace\";\nimport \"core-js/modules/es6.regexp.search\";\nimport ElTableDraggable from 'element-ui-el-table-draggable';\nvar iconv = require('iconv-lite');\nvar jschardet = require(\"jschardet\");\nimport { invoke, window } from '@tauri-apps/api';\n\n// import highlighting library (you can use any library you want just return html string)\nimport { highlight, languages } from 'prismjs/components/prism-core';\nimport 'prismjs/components/prism-clike';\nimport 'prismjs/components/prism-javascript';\nimport 'prismjs/themes/prism-tomorrow.css'; // import syntax highlighting styles\n\nexport default {\n  data: function data() {\n    var _this = this;\n    return {\n      showFlag: true,\n      code: \"\",\n      plugins: ['line-numbers'],\n      activeName: 'first',\n      winTop: '',\n      cacheFile: 'web.conf.json',\n      isWinOs: false,\n      combineHis: [\n        // {name: 'test', create_at: '2023-01-01 22:22:22', children: ['a.txt', 'b.txt']},\n        // {name: 'test', create_at: '2023-01-01 22:22:22', children: ['a.txt', 'b.txt']},\n        // {name: 'test', create_at: '2023-01-01 22:22:22', children: ['a.txt', 'b.txt']}\n      ],\n      folderData: {\n        // root\n        sourceDir: '/',\n        // children\n        files: [],\n        dirs: []\n      },\n      folderData2: {\n        sourceDir: 'root',\n        dirs: [{\n          sourceDir: 'subroot-1',\n          dirs: ['empty 1', 'empty 2', 'empty 3'],\n          files: ['file1234', 'file5678', 'filexyzw']\n        }, {\n          sourceDir: 'subroot-2',\n          dirs: ['empty 1', 'empty 2', 'empty 3'],\n          files: ['file1234', 'file5678', 'filexyzw']\n        }, {\n          sourceDir: 'subroot-3',\n          dirs: ['empty 1', 'empty 2', 'empty 3'],\n          files: ['file1234', 'file5678', 'filexyzw']\n        }],\n        files: ['a.js', 'b.js', 'c.js']\n      },\n      folderConfig: {\n        // tree node name\n        node: 'sourceDir',\n        // KEY NAME of dirs/branches/parents etc.. .\n        branch: 'dirs',\n        // KEY NAME of  files/leafs/children etc...\n        leaf: 'files'\n      },\n      ajax: function ajax(node) {\n        return _this.readFolder(node);\n        console.log(node);\n        return {\n          sourceDir: 'subroot-99',\n          dirs: [\"xxx\", 'empty 2', 'empty 3'],\n          ///仅支持当前层\n          files: ['file1234', 'file5678', 'filexyzw']\n        };\n      },\n      operatorTemplateIdx: 0,\n      dialogFolderSelectVisible: false,\n      dialogFormVisible: false,\n      selectedFolder: [],\n      fileList: [],\n      tmpFileNames: [],\n      nodeList: [],\n      nodeNum: 2,\n      replaceHis: [],\n      specialFileList: [],\n      specialBoxFileList: [],\n      specialKey: 99,\n      specialBoxKey: 98,\n      form: {\n        fileHeader: '',\n        fileFooter: '',\n        fileName: '',\n        filePath: '',\n        fileHeaderDeletedLine: 1,\n        fileFooterDeletedLine: 1,\n        fileSuffix: \".nc\",\n        fileSuffixOptions: [{\n          value: \".nc\",\n          name: \".nc\"\n        }, {\n          value: \".pim\",\n          name: \".pim\"\n        }],\n        templateList: [],\n        selectedTemplate: 0,\n        templateName: '',\n        ready: true,\n        delivery: false\n      },\n      dragOptions: {\n        animation: 120,\n        scroll: true,\n        group: 'sortlist',\n        ghostClass: 'ghost-style'\n      },\n      curId: 0,\n      combineFileList: [],\n      dragList: [],\n      dragConfig: {\n        optionVal: 0,\n        options: [{\n          value: 0,\n          label: \"文件头删除行数\"\n        }, {\n          value: 1,\n          label: \"文件尾删除行数\"\n        }],\n        setVal: 1\n      },\n      formRules: {\n        fileHeader: [{\n          required: true,\n          message: '请输入文件头',\n          trigger: 'blur'\n        }],\n        fileFooter: [{\n          required: true,\n          message: '请输入文件尾',\n          trigger: 'change'\n        }],\n        fileName: [{\n          required: true,\n          message: '请输入完整文件名',\n          trigger: 'change',\n          validator: function validator(rule, value, callback) {\n            if (!_this.form.fileName) {\n              return callback(new Error('请输入完整文件名'));\n            }\n            if (_this.form.fileSuffix === '') {\n              return callback(new Error('请选择文件后缀'));\n            }\n            callback();\n          }\n        }],\n        fileSuffix: [{\n          required: true,\n          message: '请选择文件后缀',\n          trigger: 'change'\n        }],\n        filePath: [{\n          required: true,\n          message: '请在模板里面设置文件路径',\n          trigger: 'blur'\n        }]\n      }\n    };\n  },\n  components: {\n    ElTableDraggable: ElTableDraggable\n  },\n  computed: {\n    getCombineFileNum: function getCombineFileNum() {\n      if (this.form.delivery) {\n        return this.totalNum;\n      }\n      return this.specialBoxNum;\n    },\n    getCurFolder: function getCurFolder() {\n      return this.selectedFolder.join(',');\n    },\n    replaceFlag: function replaceFlag() {\n      var _this2 = this;\n      return function (idx) {\n        if (!_this2.nodeList.hasOwnProperty(idx)) {\n          return false;\n        }\n        var node = _this2.nodeList[idx];\n        var replaceKey = _this2.createReplaceKey(node.search, node.replace);\n        return node.replaceHis.indexOf(replaceKey) != -1;\n      };\n    },\n    totalNum: function totalNum() {\n      var num = 0;\n      this.nodeList.map(function (node) {\n        num += node.fileList.length;\n      });\n      return num;\n    },\n    combineHisNum: function combineHisNum() {\n      return this.combineHis.length;\n    },\n    specialNum: function specialNum() {\n      return this.specialFileList.length;\n    },\n    specialBoxNum: function specialBoxNum() {\n      return this.specialBoxFileList.length;\n    },\n    getTemplate: function getTemplate() {\n      return this.form.templateList;\n    },\n    getCombineHisList: function getCombineHisList() {\n      return this.combineHis.sort(function (x, y) {\n        return y.create_at.localeCompare(x.create_at);\n      });\n    },\n    getFileList: {\n      get: function get() {\n        var fileList = [];\n        if (this.form.delivery) {\n          this.nodeList.map(function (node, nodeIdx) {\n            node.fileList.map(function (file, fileIdx) {\n              file.nodeIdx = nodeIdx;\n              file.fileIdx = fileIdx;\n              fileList.push(file);\n            });\n          });\n        } else {\n          //debugger\n          //fileList.push(...this.specialFileList);\n        }\n        return fileList;\n      },\n      set: function set(value) {\n        console.warn(value);\n      }\n    },\n    getFileBadge: function getFileBadge() {\n      var _this3 = this;\n      return function (rawName) {\n        return rawName + (_this3.totalNum > 0 ? '<el-badge value=\"' + _this3.totalNum + '\" class=\"large-btn\"  />' : '');\n      };\n    }\n  },\n  watch: {\n    //nodeList: {\n    // immediate: true,\n    // //deep: true,\n    // handler(nodeList) {\n    //\n    // }\n    //},\n    \"form.selectedTemplate\": {\n      immediate: false,\n      handler: function handler(value) {\n        this.selectTemplate(value);\n      }\n    }\n  },\n  created: function created() {\n    //this.initParams();\n  },\n  mounted: function mounted() {\n    this.initNodeList();\n    this.initParams();\n    this.handleWindowTop();\n    if (navigator.userAgent.toLowerCase().indexOf('windows') != -1) {\n      this.isWinOs = true;\n      this.folderData.dirs = ['C:/', 'D:/', 'E:/', 'F:/'];\n    }\n  },\n  methods: {\n    handleMouseOver: function handleMouseOver(file) {\n      this.code = file.content;\n    },\n    highlighter: function highlighter(code) {\n      //debugger\n      console.log(':highlight=\"highlighter\"');\n      console.log(code);\n      console.log(languages);\n      return highlight(code, languages.plaintext); // languages.<insert language> to return html with markup\n    },\n    handleWindowTop: function handleWindowTop() {\n      var curWin = window.getCurrent();\n      if (this.winTop === '窗口置顶') {\n        curWin.setAlwaysOnTop(true);\n        this.winTop = '取消置顶';\n      } else {\n        curWin.setAlwaysOnTop(false);\n        this.winTop = '窗口置顶';\n      }\n    },\n    delHis: function delHis(idx) {\n      //删除功能\n      this.combineHis.splice(idx, 1);\n      console.log(idx, this.combineHis);\n    },\n    delAllHis: function delAllHis() {\n      this.combineHis = [];\n    },\n    deleteNodeListFile: function deleteNodeListFile(nodeIdx, fileId) {\n      var _this4 = this;\n      var fileList = this.nodeList[nodeIdx].fileList.slice(0);\n      fileList.map(function (file) {\n        if (file.id == fileId) {\n          _this4.closeUploadedFile(nodeIdx, file, true);\n        }\n      });\n    },\n    dialogSaveFolder: function dialogSaveFolder() {\n      this.dialogFolderSelectVisible = false;\n      this.form.templateList[this.operatorTemplateIdx]['path'] = this.selectedFolder.join(',');\n      this.updateLocalStorage();\n    },\n    openFolder: function openFolder(idx) {\n      this.dialogFolderSelectVisible = true;\n      this.operatorTemplateIdx = idx;\n    },\n    basename: function basename(str) {\n      var idx = str.lastIndexOf('/');\n      idx = idx > -1 ? idx : str.lastIndexOf('\\\\');\n      if (idx < 0) {\n        return str;\n      }\n      return str.substring(idx + 1);\n    },\n    readFolder: function readFolder(node) {\n      var _this5 = this;\n      return this.wmcReadDir(node.path).then(function (res) {\n        var realPath = {\n          sourceDir: _this5.basename(node.path),\n          dirs: [],\n          ///仅支持当前层\n          files: []\n        };\n        res.map(function (item) {\n          if (item.is_dir) {\n            realPath.dirs.push(_this5.basename(item.path));\n          }\n        });\n        return realPath;\n      });\n    },\n    writeContent: function writeContent(path, content) {\n      var _this6 = this;\n      return this.wmcReadDir(node.path).then(function (res) {\n        var realPath = {\n          sourceDir: _this6.basename(node.path),\n          dirs: [],\n          ///仅支持当前层\n          files: []\n        };\n        res.map(function (item) {\n          if (item.is_dir) {\n            realPath.dirs.push(_this6.basename(item.path));\n          }\n        });\n        return realPath;\n      });\n    },\n    folderChange: function folderChange(value) {\n      console.warn(value);\n      if (this.isWinOs) {\n        value = value.map(function (res) {\n          return res.slice(1);\n        });\n      }\n      this.selectedFolder = value;\n    },\n    wmcReadDir: function wmcReadDir(path) {\n      var _this7 = this;\n      return invoke('wmc_read_dir', {\n        path: path\n      }).then(function (res) {\n        console.log(res);\n        var content = JSON.parse(res);\n        if (!content || content.length == 0) {\n          return [];\n        }\n        console.warn(content);\n        content = content.map(function (item) {\n          var parsed = item.split(',');\n          return {\n            path: _this7.fixWinsDir(parsed[0]),\n            is_dir: parsed[1] == 'true' ? true : false\n          };\n        });\n        return content;\n      });\n    },\n    fixWinsDir: function fixWinsDir(dir) {\n      if (!this.isWinOs) {\n        return dir;\n      }\n      dir = dir.replace(new RegExp(\"//\", \"g\"), '/');\n      dir = dir.replace(new RegExp(\"\\\\\\\\\", \"g\"), '/');\n      return dir;\n    },\n    wmcWrite: function wmcWrite(path, content) {\n      return invoke('wmc_write', {\n        path: path,\n        content: content\n      }).then(function (res) {\n        console.log('wmc_write: ' + res);\n        return JSON.parse(res);\n      });\n    },\n    //保存到本地文件\n    cacheRead: function cacheRead() {\n      return this.wmcRead(this.cacheFile);\n    },\n    cacheWrite: function cacheWrite(json) {\n      var _this8 = this;\n      this.cacheRead().then(function (res) {\n        res = _typeof(res) == 'object' ? res : {};\n        res = Object.assign({}, res, json);\n        _this8.wmcWrite(_this8.cacheFile, JSON.stringify(res));\n      });\n    },\n    wmcRead: function wmcRead(path) {\n      return invoke('wmc_read', {\n        path: path\n      }).then(function (res) {\n        console.log('wmc_read: ' + res);\n        return res;\n      });\n    },\n    triggerFile: function triggerFile(event) {\n      console.log(event.target.files);\n    },\n    deleteTemplate: function deleteTemplate(idx) {\n      this.form.templateList = this.form.templateList.filter(function (t, key) {\n        return key != idx;\n      });\n      console.log(this.form.templateList.length);\n      console.log(this.form.templateList);\n      if (this.form.templateList == null) {\n        this.form.templateList = [];\n      }\n    },\n    initParams: function initParams() {\n      var _this9 = this;\n      //初始化的时候，获取缓存里面的修改历史\n      var combineHisCache = localStorage.getItem('combine-his');\n      combineHisCache = JSON.parse(combineHisCache);\n      this.combineHis = combineHisCache == null ? [] : combineHisCache;\n      var formCache = localStorage.getItem('form');\n      formCache = JSON.parse(formCache);\n      if (!formCache) {\n        return \"\";\n      }\n      if (formCache != null) {\n        for (var key in formCache) {\n          this.form[key] = formCache[key];\n        }\n      }\n      return false;\n      this.cacheRead().then(function (res) {\n        if (!res) {\n          return \"\";\n        }\n        var formCache = JSON.parse(res);\n        console.log(formCache);\n        if (formCache != null) {\n          for (var _key in formCache) {\n            _this9.form[_key] = formCache[_key];\n          }\n        }\n      });\n    },\n    dialogSaveTemplate: function dialogSaveTemplate() {\n      this.dialogFormVisible = false;\n      this.selectTemplate(this.form.selectedTemplate);\n      this.updateLocalStorage();\n    },\n    updateLocalStorage: function updateLocalStorage() {\n      localStorage.setItem('form', JSON.stringify(this.form));\n\n      //存储修改历史\n      localStorage.setItem('combine-his', JSON.stringify(this.combineHis));\n      //this.cacheWrite(this.form)\n    },\n    selectTemplate: function selectTemplate(idx) {\n      this.form.templateList = this.form.templateList.filter(function (t) {\n        return t;\n      }); // remove null\n      if (!this.form.templateList.hasOwnProperty(idx)) {\n        return false;\n      }\n      var cur = this.form.templateList[idx];\n      this.form.fileFooter = cur.value;\n      this.form.templateName = cur.name;\n      this.form.filePath = cur.path;\n    },\n    addTemplate: function addTemplate() {\n      var template = {\n        name: '',\n        value: '',\n        path: ''\n      };\n      this.form.templateList.push(template);\n    },\n    showTemplate: function showTemplate() {\n      this.dialogFormVisible = true;\n    },\n    saveTemplate: function saveTemplate() {\n      var template = {\n        value: this.form.fileFooter,\n        name: this.form.templateName\n      };\n      if (!template.value) {\n        this.$message.info('请输入文件尾内容');\n        return false;\n      }\n      if (!template.name) {\n        this.$message.info('请输要保存模板名称');\n        return false;\n      }\n      for (var idx in this.form.templateList) {\n        if (this.form.templateList[idx].name == template.name) {\n          this.form.templateList[idx].value = template.value;\n          this.$message.success('模板保存成功');\n          this.updateLocalStorage();\n          return false;\n        }\n      }\n      this.form.templateList.push(template);\n      this.updateLocalStorage();\n    },\n    combineFile: function combineFile() {\n      var _this10 = this;\n      this.$refs['form'].validate(function (valid) {\n        if (!valid) {\n          return false;\n        }\n        var rawList = [];\n        var rawIds = [];\n        if (_this10.form.delivery) {\n          _this10.nodeList.map(function (node) {\n            node.fileList.map(function (file) {\n              rawIds.push(file.id);\n              rawList.push(file);\n            });\n          });\n        } else {\n          rawList.push.apply(rawList, _toConsumableArray(_this10.specialFileList));\n          rawList.push.apply(rawList, _toConsumableArray(_this10.specialBoxFileList));\n        }\n        if (rawList.length == 0) {\n          _this10.$message.info('请上传要合并的文件');\n          return false;\n        }\n        var promiseList = [];\n        var combineList = {\n          name: '',\n          create_at: _this10.getDatetime(),\n          children: []\n        };\n        rawList.map(function (file) {\n          //debugger\n          /*if(this.form.delivery && rawIds.indexOf(file.id) == -1) {\r\n              return false;\r\n          }\r\n            if(!this.form.delivery && rawIds.indexOf(file.id) != -1) {\r\n              return false;\r\n          }*/\n\n          //合并的源文件列表\n          combineList.children.push(file.name);\n          var p = _this10.readFile(file, function (res) {\n            //debugger\n            console.warn('***********res***********');\n            console.warn(res);\n            res = res.split(\"\\n\").filter(function (res) {\n              return res;\n            });\n            res.splice(0, _this10.form.fileHeaderDeletedLine);\n            res.splice(res.length - _this10.form.fileFooterDeletedLine, _this10.form.fileFooterDeletedLine);\n            return res.join(\"\\n\");\n          });\n          promiseList.push(p);\n        });\n        if (promiseList.length == 0) {\n          _this10.$message.info('请上传要合并的文件11');\n          return false;\n        }\n        _this10.form.ready = false;\n        Promise.all([].concat(promiseList)).then(function (res) {\n          console.log(res);\n          res.unshift(_this10.fixTextArea(_this10.form.fileHeader));\n          res.push(_this10.fixTextArea(_this10.form.fileFooter));\n          res = res.filter(function (res) {\n            return res;\n          });\n          console.log(\"raw res: \", res);\n          res = res.join(\"\\n\");\n          console.log(res);\n          _this10.form.ready = true;\n          //this.downloadFileByContent(res, this.form.fileName + this.form.fileSuffix);\n          _this10.wmcWrite(_this10.getFormFilePath(), res).then(function (res) {\n            console.log('合并结果', res);\n            if (res) {\n              _this10.$message.success(\"合并成功，文件：\" + _this10.getFormFilePath());\n              combineList.name = _this10.getFormFilePath();\n\n              //debug \n              console.log(combineList);\n              _this10.combineHis.push(combineList);\n              _this10.updateLocalStorage();\n              return true;\n            }\n            _this10.$message.error(\"合并失败，文件：\" + _this10.getFormFilePath() + ', 请检查文件路径是否存在或者是否有写入权限');\n          });\n        });\n        console.log('content');\n      });\n    },\n    fixTextArea: function fixTextArea(content) {\n      if (!this.isWinOs) {\n        return content;\n      }\n      return content.replace(new RegExp(\"\\n\", \"g\"), \"\\r\\n\");\n    },\n    combineFile_bak: function combineFile_bak() {\n      var _this11 = this;\n      this.$refs['form'].validate(function (valid) {\n        if (!valid) {\n          return false;\n        }\n        var rawList = [];\n        var rawIds = [];\n        _this11.nodeList.map(function (node) {\n          node.fileList.map(function (file) {\n            rawIds.push(file.id);\n            rawList.push(file);\n          });\n        });\n        rawList.push.apply(rawList, _toConsumableArray(_this11.specialFileList));\n        rawList.push.apply(rawList, _toConsumableArray(_this11.specialBoxFileList));\n        if (_this11.dragList.length != rawList.length) {\n          _this11.dragList = rawList;\n        }\n        if (_this11.dragList.length == 0) {\n          _this11.$message.info('请上传要合并的文件11');\n          return false;\n        }\n        var promiseList = [];\n        _this11.dragList.map(function (file) {\n          //debugger\n          /*if(this.form.delivery && rawIds.indexOf(file.id) == -1) {\r\n              return false;\r\n          }\r\n            if(!this.form.delivery && rawIds.indexOf(file.id) != -1) {\r\n              return false;\r\n          }*/\n\n          var p = _this11.readFile(file, function (res) {\n            res = res.split(\"\\n\").filter(function (res) {\n              return res;\n            });\n            res.splice(0, file.headerDeleteLine);\n            res.splice(res.length - file.footerDeleteLine, file.footerDeleteLine);\n            return res.join(\"\\n\");\n          });\n          promiseList.push(p);\n        });\n        if (promiseList.length == 0) {\n          _this11.$message.info('请上传文件33');\n          return false;\n        }\n        _this11.form.ready = false;\n        Promise.all([].concat(promiseList)).then(function (res) {\n          console.log(res);\n          res.unshift(_this11.form.fileHeader);\n          res.push(_this11.form.fileFooter);\n          res = res.filter(function (res) {\n            return res;\n          });\n          res = res.join(\"\\n\");\n          console.log(res);\n          _this11.form.ready = true;\n          //this.downloadFileByContent(res, this.form.fileName + this.form.fileSuffix);\n          _this11.wmcWrite(_this11.getFormFilePath(), res).then(function (res) {\n            console.log('合并结果', res);\n            if (res) {\n              _this11.$message.success(\"合并成功，文件：\" + _this11.getFormFilePath());\n              return true;\n            }\n            _this11.$message.error(\"合并失败，文件：\" + _this11.getFormFilePath() + ', 请检查文件路径是否存在或者是否有写入权限');\n          });\n        });\n        console.log('content');\n      });\n    },\n    getFormFilePath: function getFormFilePath() {\n      return this.form.filePath + '/' + this.form.fileName + this.form.fileSuffix;\n    },\n    test: function test(flag) {\n      return new Promise(function (resolve, reject) {\n        var time = Math.ceil(Math.random() * 10000);\n        console.warn('执行 ' + flag);\n        setTimeout(function () {\n          resolve(time + '-' + flag);\n        }, time);\n      });\n    },\n    readFile: function readFile(file, callback) {\n      var _this12 = this;\n      return new Promise(function (resolve, reject) {\n        var fileReader = new FileReader();\n        fileReader.onloadend = function (event) {\n          console.warn(event);\n          console.warn(_this12.detectCharset(event.target.result));\n          resolve(callback(_this12.fileContentDecode(event.target.result)));\n        };\n        fileReader.readAsBinaryString(file.raw);\n      });\n    },\n    fileConfigAdd: function fileConfigAdd() {\n      this.dispatchFileConfig(true);\n    },\n    fileConfigReduce: function fileConfigReduce() {\n      this.dispatchFileConfig(false);\n    },\n    dispatchFileConfig: function dispatchFileConfig() {\n      var _this13 = this;\n      var isAdd = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n      if (this.form.delivery) {\n        this.nodeList.map(function (node) {\n          node.fileList.map(function (file) {\n            _this13.doUpdateDeletedLine(file, isAdd);\n          });\n        });\n      } else {\n        this.specialFileList.map(function (file) {\n          _this13.doUpdateDeletedLine(file, isAdd);\n        });\n      }\n    },\n    doUpdateDeletedLine: function doUpdateDeletedLine(file) {\n      var isAdd = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n      var key = this.dragConfig.optionVal == 0 ? 'headerDeleteLine' : 'footerDeleteLine';\n      file[key] = file[key] == undefined ? 0 : file[key];\n      if (isAdd) {\n        file[key] += this.dragConfig.setVal;\n      } else {\n        file[key] -= this.dragConfig.setVal;\n      }\n      file[key] = file[key] < 0 ? 0 : file[key];\n      this.updateDeletedLine(file.id, key, file[key]);\n    },\n    updateDeletedLine: function updateDeletedLine(id, mode, value) {\n      var key = this.createDeleteKey(id, mode);\n      this.$refs[key].setCurrentValue(value);\n    },\n    dragChange: function dragChange(log) {\n      this.dragList = log.list;\n      console.log(log);\n    },\n    formReset: function formReset() {\n      this.$refs.form.resetFields();\n      for (var key in this.form) {\n        if (key == 'fileSuffixOptions') {\n          continue;\n        }\n        if (this.form.hasOwnProperty(key)) {\n          this.form[key] = key == 'ready' || key == \"delivery\" ? true : '';\n        }\n      }\n    },\n    removeHandle: function removeHandle(event) {\n      console.log(event);\n      this.$message.success(\"\\u4ECE \".concat(event.from.id, \" \\u79FB\\u52A8\\u5230 \").concat(event.to.id, \" \"));\n    },\n    addNode: function addNode() {\n      this.nodeList.push(this.initNode());\n    },\n    batchReplace: function batchReplace() {\n      var _this14 = this;\n      this.nodeList.map(function (node, idx) {\n        if (node.fileList.length == 0) {\n          return false;\n        }\n        _this14.doReplace(idx, true);\n      });\n    },\n    batchDownload: function batchDownload() {\n      var _this15 = this;\n      this.nodeList.map(function (node, idx) {\n        if (node.fileList.length == 0) {\n          return false;\n        }\n        _this15.downloadFile(idx);\n      });\n    },\n    clearBoxFileList: function clearBoxFileList() {\n      var _this16 = this;\n      if (this.form.delivery) {\n        for (var idx in this.nodeList) {\n          this.clearSearchReplace(idx);\n        }\n      } else {\n        var deletedList = this.specialBoxFileList.slice(0);\n        deletedList.map(function (file, key) {\n          _this16.closeUploadedFile(_this16.specialBoxKey, file, false);\n        });\n      }\n    },\n    clearSearchReplace: function clearSearchReplace(idx) {\n      var _this17 = this;\n      //debugger\n      if (this.nodeList[idx].fileList.length == 0) {\n        return false;\n      }\n      var deletedList = this.nodeList[idx].fileList.slice(0);\n      console.log(deletedList);\n      deletedList.map(function (file, key) {\n        //debugger\n        console.warn(file.name, key);\n        _this17.closeUploadedFile(idx, file);\n      });\n\n      /*let node = this.initNode();\r\n      for(let key in node) {\r\n          this.nodeList[idx][key] = node[key];\r\n      }*/\n    },\n    closeUploadedFile: function closeUploadedFile(idx, file) {\n      var isMulti = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;\n      var ref = this.$refs[this.createUploadKey(idx)];\n      if (isMulti) {\n        ref = ref[0];\n      }\n      ref.handleRemove(file, file.raw);\n    },\n    getReplaceHis: function getReplaceHis(idx) {\n      if (this.nodeList[idx].replaceHis.length == 0) {\n        this.$message.info('没有替换历史');\n        return false;\n      }\n      var hisHtml = '';\n      this.nodeList[idx].replaceHis.map(function (his, key) {\n        hisHtml += \"<p>#\".concat(key, \" \").concat(his, \"<p>\");\n      });\n      this.$alert(hisHtml, '替换历史', {\n        dangerouslyUseHTMLString: true\n      });\n    },\n    doReplace: function doReplace(idx) {\n      var _this18 = this;\n      var isBatch = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n      if (this.nodeList[idx].fileList.length == 0) {\n        if (!isBatch) {\n          this.$message.info(\"请先上传文件！\");\n        }\n        return false;\n      }\n      var node = this.nodeList[idx];\n      var replaceKey = this.createReplaceKey(node.search, node.replace);\n      node.replaceHis.push(replaceKey);\n      var promiseList = [];\n      node.fileList.map(function (file) {\n        var p = _this18.readFile(file, function (res) {\n          res = res.replace(new RegExp(node.search, 'g'), node.replace);\n          //debugger\n          file.raw = new File([res], file.name, {\n            name: file.name,\n            size: res.length,\n            type: file.type,\n            uid: file.uid,\n            lastModified: file.lastModified\n          });\n          file.raw.uid = file.uid;\n          _this18.$message({\n            message: file.name + ' 替换成功',\n            type: 'success'\n          });\n          return res;\n        });\n        promiseList.push(p);\n      });\n      Promise.all([].concat(promiseList)).then(function (res) {\n        console.log('replace res: ', res);\n      });\n    },\n    fileContentDecode: function fileContentDecode(binaryStr) {\n      return iconv.decode(binaryStr, this.detectCharset(binaryStr));\n    },\n    detectCharset: function detectCharset(binaryStr) {\n      var collect = jschardet.detectAll(binaryStr);\n      var result = '';\n      var confidence = 0;\n      for (var idx in collect) {\n        if (collect[idx].confidence > confidence) {\n          result = collect[idx].encoding;\n          confidence = collect[idx].confidence;\n        }\n      }\n      if (['TIS-620', 'windows-1252'].indexOf(result) != -1) {\n        result = 'GBK';\n      }\n      console.error(collect, result);\n      return result;\n    },\n    downloadFileByContent: function downloadFileByContent(content, fileName) {\n      var file = new File([content], fileName, {\n        type: 'text/plain'\n      });\n      console.warn(file);\n      this.downloadBlob(URL.createObjectURL(file), fileName);\n    },\n    downloadFile: function downloadFile(idx) {\n      var _this19 = this;\n      if (!this.nodeList.hasOwnProperty(idx)) {\n        this.$message.info(\"请上传文件！\");\n        return false;\n      }\n      if (!this.form.filePath) {\n        this.$message.info(\"程式保存路径未配置，请到程式串联页面配置\");\n        return false;\n      }\n      this.nodeList[idx].fileList.map(function (file) {\n        var name = file.name.substring(0, file.name.lastIndexOf(\".\"));\n        var suffix = file.name.substring(file.name.lastIndexOf(\".\"));\n        if (_this19.nodeList[idx].replaceHis.length > 0) {\n          //name += \"(\" + this.nodeList[idx].replaceHis.join(\",\") + \")\";\n        }\n        console.warn(file.name);\n        //this.downloadBlob(url, name + suffix);\n        _this19.readFile(file, function (res) {\n          var path = _this19.form.filePath + \"/\" + name + suffix;\n          _this19.wmcWrite(path, res);\n          _this19.$message.success(\"程式保存成功，程式名： \" + path);\n        });\n      });\n    },\n    initNodeList: function initNodeList() {\n      for (var i = 0; i < this.nodeNum; i++) {\n        this.nodeList.push(this.initNode());\n      }\n    },\n    initNode: function initNode() {\n      return {\n        search: '',\n        replace: '',\n        fileNum: 0,\n        fileList: [\n          //{name: \"test.json\", uid: 55555, id:1}\n        ],\n        isReplace: false,\n        replaceHis: []\n      };\n    },\n    handleClick: function handleClick(tab, event) {\n      console.log(tab, event);\n    },\n    handleRemove: function handleRemove(idx) {\n      var _this20 = this;\n      return function (file, fileList) {\n        console.log(idx, file, fileList);\n        /*for(var key in fileList) {\r\n            if(file.name == fileList[key].name) {\r\n                return false;\r\n            }\r\n        }*/\n\n        if (idx == _this20.specialKey) {\n          _this20.specialFileList = fileList;\n        } else if (idx == _this20.specialBoxKey) {\n          _this20.specialBoxFileList = fileList;\n        } else {\n          _this20.nodeList[idx].fileNum--;\n          _this20.nodeList[idx].fileList = fileList;\n          if (fileList.length == 0) {\n            _this20.nodeList[idx].replaceHis = [];\n          }\n        }\n        var nameIdx = _this20.tmpFileNames[idx].indexOf(file.name);\n        delete _this20.tmpFileNames[idx][nameIdx];\n      };\n    },\n    handlePreview: function handlePreview(file) {\n      console.log(file);\n    },\n    handleProgress: function handleProgress(event, file, fileList) {\n      console.log(event, file);\n    },\n    myHandleChange: function myHandleChange(idx) {\n      var _this21 = this;\n      return function (file, fileList) {\n        if (!_this21.tmpFileNames.hasOwnProperty(idx)) {\n          _this21.tmpFileNames[idx] = [];\n        }\n        if (_this21.tmpFileNames[idx].indexOf(file.name) != -1) {\n          _this21.$message.warning(\"出现重复文件： \" + file.name + \", 取消当前上传！\");\n          console.log(_this21.createUploadKey(idx));\n          console.log(_this21.$refs[_this21.createUploadKey(idx)]);\n          if (idx == _this21.specialKey || idx == _this21.specialBoxKey) {\n            _this21.$refs[_this21.createUploadKey(idx)].handleRemove(file, file.raw);\n          } else {\n            _this21.$refs[_this21.createUploadKey(idx)][0].handleRemove(file, file.raw);\n          }\n          return false;\n        }\n        file.id = _this21.createId();\n        file.headerDeleteLine = 1;\n        file.footerDeleteLine = 1;\n\n        //cache file content \n        _this21.readFile(file, function (res) {\n          file.content = res;\n        });\n\n        //file.\n        if (idx == _this21.specialKey) {\n          //debugger\n          _this21.specialFileList = fileList;\n          console.log(_this21.specialFileList);\n        } else if (idx == _this21.specialBoxKey) {\n          _this21.specialBoxFileList = fileList;\n          console.log(fileList);\n        } else {\n          _this21.nodeList[idx].fileNum++;\n          _this21.nodeList[idx].fileList = fileList;\n        }\n        _this21.tmpFileNames[idx].push(file.name);\n      };\n    },\n    downloadBlob: function downloadBlob(blobUrl, fileName, revokeObjectURL) {\n      var downloadElement = document.createElement('a');\n      downloadElement.href = blobUrl;\n      //下载后文件名\n      downloadElement.download = fileName;\n      console.log(fileName);\n      document.body.appendChild(downloadElement);\n      //点击下载\n      downloadElement.click();\n      //下载完成移除元素\n      document.body.removeChild(downloadElement);\n      if (revokeObjectURL == null || revokeObjectURL) {\n        //释放掉blob对象\n        window.URL.revokeObjectURL(blobUrl);\n      }\n    },\n    createUploadKey: function createUploadKey(idx) {\n      return 'upload' + idx;\n    },\n    createReplaceKey: function createReplaceKey(search, replace) {\n      return search + ' = ' + replace;\n    },\n    createId: function createId() {\n      return this.curId++;\n    },\n    createDeleteKey: function createDeleteKey(id, mode) {\n      return id + '-' + mode;\n    },\n    getDatetime: function getDatetime() {\n      var dateObj = new Date();\n      var datetime = dateObj.getFullYear() + '-' + this.fixDate(dateObj.getMonth()) + '-' + this.fixDate(dateObj.getDate()) + ' ' + this.fixDate(dateObj.getHours()) + ':' + this.fixDate(dateObj.getMinutes()) + ':' + this.fixDate(dateObj.getSeconds());\n      return datetime;\n    },\n    fixDate: function fixDate(num) {\n      if (num.toString().length > 1) {\n        return num;\n      }\n      return \"0\" + num;\n    }\n  }\n};",{"version":3,"mappings":";;;;;;;;;;;;;;;;AAqTA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;EACAA;IAAA;IACA;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;QACA;QACA;QACA;MAAA,CACA;MACAC;QACA;QACAC;QACA;QACAC;QACAC;MACA;MACAC;QACAH;QACAE;UACAF;UACAE;UACAD;QACA;UACAD;UACAE;UACAD;QACA;UACAD;UACAE;UACAD;QACA;QACAA;MACA;MAEAG;QACA;QACAC;QACA;QACAC;QACA;QACAC;MACA;MACAC;QAEA;QAEAC;QACA;UACAT;UACAE;UAAA;UACAD;QACA;MACA;MAEAS;MAEAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC,sBACA;MACAC;MACAC;MACAC;QACAC;QACAC;QACAC;QACAC;QACAC;QACAC;QACAC;QACAC,oBACA;UAAAC;UAAAC;QAAA,GACA;UAAAD;UAAAC;QAAA,EACA;QACAC;QACAC;QACAC;QACAC;QACAC;MACA;MACAC;QACAC;QACAC;QACAC;QACAC;MACA;MACAC;MACAC,mBACA;MAEAC;MACAC;QACAC;QACAC,UACA;UAAAjB;UAAAkB;QAAA,GACA;UAAAlB;UAAAkB;QAAA,EACA;QAEAC;MACA;MAEAC;QACA5B,aACA;UAAA6B;UAAAC;UAAAC;QAAA,EACA;QACA9B,aACA;UAAA4B;UAAAC;UAAAC;QAAA,EACA;QACA7B,WACA;UAAA2B;UAAAC;UAAAC;UAAAC;YACA;cACA;YACA;YAEA;cACA;YACA;YAEAC;UACA;QAAA,EACA;QACA3B,aACA;UAAAuB;UAAAC;UAAAC;QAAA,EACA;QACA5B,WACA;UAAA0B;UAAAC;UAAAC;QAAA;MAGA;IACA;EACA;EACAG;IACAC;EACA;EACAC;IACAC;MACA;QACA;MACA;MACA;IACA;IACAC;MACA;IACA;IACAC;MAAA;MACA;QACA;UACA;QACA;QAEA;QACA;QACA;MACA;IACA;IACAC;MACA;MACA;QACAC;MACA;MAEA;IACA;IACAC;MACA;IACA;IACAC;MACA;IACA;IACAC;MACA;IACA;IAEAC;MACA;IACA;IAEAC;MACA;QACA;MACA;IACA;IAEAC;MACAC;QACA;QAEA;UACA;YACAnE;cACAoE;cACAA;cACA3D;YACA;UACA;QACA;UACA;UACA;QACA;QAEA;MACA;MACA4D;QACAjE;MACA;IACA;IACAkE;MAAA;MACA;QACA;MACA;IACA;EACA;EAEAC;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;MACAC;MACAC;QACA;MACA;IACA;EACA;EACAC;IACA;EACA;EACAC;IACA;IACA;IACA;IAEA;MACA;MACA;IACA;EACA;EAEAC;IACAC;MACA;IACA;IACAC;MACA;MACA1E;MACAA;MACAA;MACA;IACA;IACA2E;MACA;MACA;QACAC;QACA;MACA;QACAA;QACA;MACA;IACA;IACAC;MACA;MACA;MACA7E;IACA;IACA8E;MACA;IACA;IACAC;MAAA;MACA;MACA1E;QACA;UACA;QACA;MACA;IACA;IACA2E;MACA;MACA;MACA;IACA;IACAC;MACA;MACA;IACA;IACAC;MACA;MACAC;MACA;QACA;MACA;MACA;IACA;IAEAC;MAAA;MACA;QACA;UACA7F;UACAE;UAAA;UACAD;QACA;QACA6F;UACA;YACAC;UACA;QACA;QAEA;MACA;IACA;IAEAC;MAAA;MACA;QACA;UACAhG;UACAE;UAAA;UACAD;QACA;QACA6F;UACA;YACAC;UACA;QACA;QAEA;MACA;IACA;IAEAE;MACAxF;MACA;QACAuB;UACA;QACA;MACA;MAEA;IACA;IAEAkE;MAAA;MACA;QAAAC;MAAA;QACA1F;QAEA;QACA;UACA;QACA;QAEAA;QACA2F;UACA;UACA;YACAD;YACAE;UACA;QACA;QAEA;MACA;IACA;IAEAC;MACA;QACA;MACA;MAEAC;MACAA;MAEA;IACA;IAEAC;MACA;QAAAL;QAAAC;MAAA;QACA3F;QAEA;MACA;IACA;IAEA;IACAgG;MACA;IACA;IAEAC;MAAA;MACA;QACAZ;QACAA;QACA;MACA;IACA;IAEAa;MACA;QAAAR;MAAA;QACA1F;QAEA;MACA;IACA;IAEAmG;MACAnG;IACA;IACAoG;MAEA;QAAA;MAAA;MACApG;MACAA;MACA;QACA;MACA;IACA;IACAqG;MAAA;MACA;MACA;MACAC;MACA;MAEA;MACAC;MACA;QACA;MACA;MAEA;QACA;UACA;QACA;MACA;MAEA;MACA;QACA;UACA;QACA;QAEA;QACAvG;QACA;UACA;YACA;UACA;QACA;MACA;IACA;IACAwG;MACA;MACA;MACA;IACA;IACAC;MACAC;;MAEA;MACAA;MACA;IACA;IACAC;MACA;QAAA;MAAA;MACA;QACA;MACA;MAEA;MACA;MACA;MACA;IACA;IAEAC;MACA;QAAApF;QAAAD;QAAAmE;MAAA;MACA;IACA;IAEAmB;MACA;IACA;IAEAC;MACA;QACAvF;QACAC;MACA;MAEA;QACA;QACA;MACA;MAEA;QACA;QACA;MACA;MAEA;QACA;UACA;UACA;UACA;UACA;QACA;MACA;MAEA;MACA;IACA;IAEAuF;MAAA;MACA;QACA;UACA;QACA;QAEA;QACA;QAEA;UACA;YACAnH;cACAoH;cACAC;YACA;UACA;QACA;UACAA;UACAA;QACA;QAEA;UACA;UACA;QACA;QAEA;QACA;UAAAzF;UAAA0F;UAAAC;QAAA;QACAF;UACA;UACA;AACA;AACA;;AAEA;AACA;;UAGA;UACAG;UAEA;YACA;YACApH;YACAA;YACAqF;cAAA;YAAA;YACAA;YACAA;YACA;UACA;UAEAgC;QACA;QAEA;UACA;UACA;QACA;QAEA;QACAC;UACAtH;UACAqF;UACAA;UACAA;YAAA;UAAA;UACArF;UACAqF;UAEArF;UACA;UACA;UACA;YACAA;YACA;cACA;cAEAoH;;cAEA;cACApH;cACA;cACA;cAEA;YACA;YAEA;UACA;QACA;QAEAA;MACA;IACA;IAEAuH;MACA;QACA;MACA;MAEA;IACA;IAEAC;MAAA;MACA;QACA;UACA;QACA;QAEA;QACA;QACA;UACA5H;YACAoH;YACAC;UACA;QACA;QAEAA;QACAA;QAEA;UACA;QACA;QAEA;UACA;UACA;QACA;QAEA;QACA;UACA;UACA;AACA;AACA;;AAEA;AACA;;UAGA;YACA5B;cAAA;YAAA;YACAA;YACAA;YACA;UACA;UAEAgC;QACA;QAEA;UACA;UACA;QACA;QAEA;QACAC;UACAtH;UACAqF;UACAA;UACAA;YAAA;UAAA;UACAA;UAEArF;UACA;UACA;UACA;YACAA;YACA;cACA;cACA;YACA;YAEA;UACA;QACA;QAEAA;MACA;IACA;IAEAyH;MACA;IACA;IAEAC;MACA;QACA;QACA1H;QACA2H;UACAC;QACA;MACA;IACA;IAGAC;MAAA;MACA;QACA;QACAC;UACA9H;UACAA;UACA4H;QACA;QAEAE;MACA;IACA;IACAC;MACA;IACA;IAEAC;MACA;IACA;IAEAC;MAAA;MAAA;MACA;QACA;UACArI;YACA;UACA;QACA;MACA;QACA;UACA;QACA;MACA;IACA;IAEAsI;MAAA;MACA;MACAlE;MACA;QACAA;MACA;QACAA;MACA;MAEAA;MACA;IACA;IAEAmE;MACA;MACA;IACA;IAEAC;MACA;MACApI;IAEA;IACAqI;MACA;MACA;QACA;UACA;QACA;QAEA;UACA;QACA;MACA;IACA;IACAC;MACAtI;MACA;IACA;IACAuI;MACA;IACA;IAEAC;MAAA;MACA;QACA;UACA;QACA;QAEA;MACA;IACA;IAEAC;MAAA;MACA;QACA;UACA;QACA;QAEA;MACA;IACA;IAEAC;MAAA;MACA;QACA;UACA;QACA;MACA;QACA;QACAC;UACA;QACA;MACA;IACA;IAEAC;MAAA;MAEA;MACA;QACA;MACA;MAEA;MACA5I;MACA2I;QACA;QACA3I;QACA;MACA;;MAEA;AACA;AACA;AACA;IACA;IAEA6I;MAAA;MACA;MACA;QACAC;MACA;MAEAA;IACA;IACAC;MACA;QACA;QACA;MACA;MAEA;MACA;QACAC;MACA;MAEA;QACAC;MACA;IACA;IAEAC;MAAA;MAAA;MAEA;QACA;UACA;QACA;QAEA;MACA;MAEA;MACA;MACAtJ;MAEA;MACAA;QACA;UACAyF;UACA;UACArB;YACAxC;YACA2H;YACAC;YACAC;YACAC;UACA;UAEAtF;UACA;YACAnB;YACAuG;UACA;UAEA;QACA;QAEA/B;MACA;MAEAC;QACAtH;MACA;IACA;IAEAuJ;MACA;IACA;IAEAC;MACA;MACA;MACA;MAEA;QACA;UACAC;UACAC;QACA;MACA;MAEA;QACAD;MACA;MAEAzJ;MAEA;IACA;IAEA2J;MACA;QACAP;MACA;MACApJ;MACA;IACA;IAEA4J;MAAA;MACA;QACA;QACA;MACA;MAEA;QACA;QACA;MACA;MAEA;QACA;QACA;QACA;UACA;QACA;QAEA5J;QACA;QACA;UACA;UACA;UACA;QACA;MACA;IACA;IACA6J;MACA;QACA;MACA;IACA;IACAC;MACA;QACAC;QACAC;QACAC;QACA5J;UACA;QAAA,CACA;QACA6J;QACAzJ;MACA;IACA;IACA0J;MACAnK;IACA;IAEAoK;MAAA;MACA;QACApK;QACA;AACA;AACA;AACA;AACA;;QAEA;UACA;QACA;UACA;QACA;UACA;UACA;UAEA;YACA;UACA;QACA;QAEA;QACA;MACA;IACA;IAEAqK;MACArK;IACA;IACAsK;MACAtK;IACA;IAEAuK;MAAA;MACA;QACA;UACA;QACA;QAEA;UACA;UACAvK;UACAA;UAEA;YACA;UACA;YACA;UACA;UAEA;QACA;QAEAgE;QACAA;QACAA;;QAEA;QACA;UAAAA;QAAA;;QAEA;QACA;UACA;UACA;UACAhE;QACA;UACA;UACAA;QACA;UACA;UACA;QACA;QAEA;MACA;IACA;IAEAwK;MACA;MACAC;MACA;MACAA;MACAzK;MACA0K;MACA;MACAD;MACA;MACAC;MACA;QACA;QACAC;MACA;IACA;IAEAC;MACA;IACA;IAEAC;MACA;IACA;IAEAC;MACA;IACA;IAEAC;MACA;IACA;IAEAC;MACA;MAEA,6CACA,yCACA,wCACA,yCACA,2CACA;MAEA;IACA;IACAC,+BACA;MACA;QACA;MACA;MAEA;IACA;EAEA;AACA","names":["data","showFlag","code","plugins","activeName","winTop","cacheFile","isWinOs","combineHis","folderData","sourceDir","files","dirs","folderData2","folderConfig","node","branch","leaf","ajax","console","operatorTemplateIdx","dialogFolderSelectVisible","dialogFormVisible","selectedFolder","fileList","tmpFileNames","nodeList","nodeNum","replaceHis","specialFileList","specialBoxFileList","specialKey","specialBoxKey","form","fileHeader","fileFooter","fileName","filePath","fileHeaderDeletedLine","fileFooterDeletedLine","fileSuffix","fileSuffixOptions","value","name","templateList","selectedTemplate","templateName","ready","delivery","dragOptions","animation","scroll","group","ghostClass","curId","combineFileList","dragList","dragConfig","optionVal","options","label","setVal","formRules","required","message","trigger","validator","callback","components","ElTableDraggable","computed","getCombineFileNum","getCurFolder","replaceFlag","totalNum","num","combineHisNum","specialNum","specialBoxNum","getTemplate","getCombineHisList","getFileList","get","file","set","getFileBadge","watch","immediate","handler","created","mounted","methods","handleMouseOver","highlighter","handleWindowTop","curWin","delHis","delAllHis","deleteNodeListFile","dialogSaveFolder","openFolder","basename","idx","readFolder","res","realPath","writeContent","folderChange","wmcReadDir","path","content","is_dir","fixWinsDir","dir","wmcWrite","cacheRead","cacheWrite","wmcRead","triggerFile","deleteTemplate","initParams","combineHisCache","formCache","dialogSaveTemplate","updateLocalStorage","localStorage","selectTemplate","addTemplate","showTemplate","saveTemplate","combineFile","rawIds","rawList","create_at","children","combineList","promiseList","Promise","fixTextArea","combineFile_bak","getFormFilePath","test","setTimeout","resolve","readFile","fileReader","fileConfigAdd","fileConfigReduce","dispatchFileConfig","doUpdateDeletedLine","updateDeletedLine","dragChange","formReset","removeHandle","addNode","batchReplace","batchDownload","clearBoxFileList","deletedList","clearSearchReplace","closeUploadedFile","ref","getReplaceHis","hisHtml","dangerouslyUseHTMLString","doReplace","size","type","uid","lastModified","fileContentDecode","detectCharset","result","confidence","downloadFileByContent","downloadFile","initNodeList","initNode","search","replace","fileNum","isReplace","handleClick","handleRemove","handlePreview","handleProgress","myHandleChange","downloadBlob","downloadElement","document","window","createUploadKey","createReplaceKey","createId","createDeleteKey","getDatetime","fixDate"],"sourceRoot":"src/components/page","sources":["Combine.vue"],"sourcesContent":["<template>\r\n    <el-row :gutter=\"10\">\r\n        <el-col :span=\"24\" :offset=\"0\" class=\"wrap\">\r\n            <el-tabs v-model=\"activeName\" @tab-click=\"handleClick\">\r\n\r\n                <el-tab-pane  name=\"first\" class=\"wrap-padding\">\r\n                    <span slot=\"label\">程式替换<el-badge :value=\"totalNum\" class=\"large-btn\" :hidden=\"totalNum > 0 ? false : true\" ></el-badge></span>\r\n\r\n                    <el-col :span=\"12\" class=\"margin-bottom-10\" v-for=\"(item, idx) in nodeList\">\r\n                        <el-card class=\"box-card\">\r\n                            <div slot=\"header\" class=\"clearfix\">\r\n                                <el-col :span=\"5\">\r\n                                    <el-input v-model=\"item.search\" prefix-icon=\"el-icon-search\" placeholder=\"查找\"></el-input>\r\n                                </el-col>\r\n                                <el-col :span=\"5\">\r\n                                    <el-input v-model=\"item.replace\" prefix-icon=\"el-icon-edit\" placeholder=\"替换\"></el-input>\r\n                                </el-col>\r\n                                <el-badge :value=\"item.fileNum\" class=\"\" :hidden=\"item.fileNum > 0 ? false : true\">\r\n                                    <el-button v-show=\"!replaceFlag(idx)\" size=\"small\" class=\"ml-3\" type=\"primary\"\r\n                                               @click=\"doReplace(idx)\">替换\r\n                                    </el-button>\r\n                                    <el-button v-show=\"replaceFlag(idx)\" class=\"ml-3\" size=\"small\" type=\"success\">已替换</el-button>\r\n                                </el-badge>\r\n                                <el-button size=\"small\" type=\"primary\" class=\"margin-left-3\" @click=\"downloadFile(idx)\">下载</el-button>\r\n                                <el-button size=\"small\" type=\"danger\" class=\"margin-left-3\" @click=\"clearSearchReplace(idx)\">清空</el-button>\r\n                                <el-button size=\"small\" type=\"success\" class=\"ml-3\" @click=\"getReplaceHis(idx)\">替换历史</el-button>\r\n\r\n                            </div>\r\n                            <div class=\"content-overflow\">\r\n                                <el-upload\r\n                                        class=\"sr-upload-demo\"\r\n                                        drag\r\n                                        :ref=\"createUploadKey(idx)\"\r\n                                        action=\"\"\r\n                                        :on-preview=\"handlePreview\"\r\n                                        :on-remove=\"handleRemove(idx)\"\r\n                                        :on-progress=\"handleProgress\"\r\n                                        :on-change=\"myHandleChange(idx)\"\r\n                                        :auto-upload=\"false\"\r\n                                        multiple>\r\n                                    <i class=\"el-icon-upload\" v-show=\"item.fileNum == 0\"></i>\r\n                                    <div class=\"el-upload__text\" v-show=\"item.fileNum == 0\">将文件拖到此处，或<em>点击上传</em></div>\r\n                                    \r\n                                    <div slot=\"file\" slot-scope=\"{file}\">\r\n                                        <a class=\"el-upload-list__item-name\"><i class=\"el-icon-document\"></i>{{file.name}}</a>\r\n                                        <label class=\"el-upload-list__item-status-label\">\r\n                                            <i class=\"el-icon-upload-success el-icon-circle-check\"></i>\r\n                                        </label>\r\n                                        <el-tooltip class=\"item\" effect=\"light\"  placement=\"right\">\r\n                                            <div class=\"prism-editor-wrap\"  slot=\"content\">\r\n                                                <prism-editor class=\"my-editor\" v-model=\"code\" :highlight=\"highlighter\" line-numbers readonly></prism-editor>\r\n                                            </div>\r\n                                            <i class=\"el-icon-close\" style=\"width: 20px;\" @click=\"closeUploadedFile(idx, file, true)\" @mouseover=\"handleMouseOver(file)\"></i>\r\n                                        </el-tooltip>\r\n                                    </div>\r\n                                </el-upload>\r\n                            </div>\r\n\r\n                        </el-card>\r\n                    </el-col>\r\n\r\n                    <el-col :span=\"12\" class=\"margin-bottom-10\">\r\n                        <div class=\"my-avatar-uploader content-overflow\" @click=\"addNode\">\r\n                            <i class=\"el-icon-plus avatar-uploader-icon\"></i>\r\n                        </div>\r\n\r\n                        <el-row class=\"mt-10\">\r\n                            <el-badge :value=\"totalNum\" class=\"large-btn\" :hidden=\"totalNum > 0 ? false : true\" >\r\n                                <el-button type=\"danger\" size=\"medium\" class=\"large-btn\" @click=\"batchReplace\">批量替换</el-button>\r\n                            </el-badge>\r\n                        </el-row>\r\n\r\n                        <el-row class=\"mt-10\">\r\n                            <el-button type=\"primary\" size=\"medium\" class=\"large-btn\" @click=\"batchDownload\">批量下载</el-button>\r\n                        </el-row>\r\n\r\n                    </el-col>\r\n\r\n\r\n                </el-tab-pane>\r\n\r\n\r\n                <el-tab-pane label=\"程式串联\" name=\"third\" style=\"margin-top: 10px;\" class=\"third-box\">\r\n                    <el-col :span=\"10\">\r\n                        <el-card class=\"box-card\" shadow=\"never\" >\r\n                            <span class=\"box-card-title\">要串联的程式</span>\r\n\r\n                            <div class=\"content-overflow\">\r\n                                <el-upload v-show=\"!form.delivery\"\r\n                                        class=\"upload-demo\"\r\n                                        drag\r\n                                        :ref=\"createUploadKey(specialBoxKey)\"\r\n                                        action=\"\"\r\n                                        :on-preview=\"handlePreview\"\r\n                                        :on-remove=\"handleRemove(specialBoxKey)\"\r\n                                        :on-progress=\"handleProgress\"\r\n                                        :on-change=\"myHandleChange(specialBoxKey)\"\r\n                                        :auto-upload=\"false\"\r\n                                        :disabled=\"false\"\r\n                                        multiple>\r\n                                    <i class=\"el-icon-upload\" v-show=\"specialBoxFileList.length == 0\"></i>\r\n                                    <div class=\"el-upload__text\" v-show=\"specialBoxFileList == 0\">将文件拖到此处，或<em>点击上传</em></div>\r\n                                    <div slot=\"file\" slot-scope=\"{file}\">\r\n                                        <a class=\"el-upload-list__item-name\"><i class=\"el-icon-document\"></i>{{file.name}}</a>\r\n                                        <label class=\"el-upload-list__item-status-label\">\r\n                                            <i class=\"el-icon-upload-success el-icon-circle-check\"></i>\r\n                                        </label>\r\n                                        <el-tooltip class=\"item\" effect=\"light\"  placement=\"right\">\r\n                                            <div class=\"prism-editor-wrap\"  slot=\"content\">\r\n                                                <prism-editor class=\"my-editor\" v-model=\"code\" :highlight=\"highlighter\" line-numbers readonly></prism-editor>\r\n                                            </div>\r\n                                            <i class=\"el-icon-close\" style=\"width: 20px;\" @click=\"closeUploadedFile(specialBoxKey, file, false)\" @mouseover=\"handleMouseOver(file)\"></i>\r\n                                        </el-tooltip>\r\n                                    </div>\r\n                                </el-upload>\r\n\r\n                                <ul class=\"el-upload-list el-upload-list--text att\" v-show=\"form.delivery\">\r\n                                    <el-empty description=\"请在程式替换页面上传文件\" v-show=\"getFileList.length == 0\">\r\n                                        <el-button type=\"primary\" plain @click=\"activeName='first'\">去上传</el-button>\r\n                                    </el-empty>\r\n\r\n                                    <li tabindex=\"0\" class=\"el-upload-list__item is-ready\" v-for=\"file in getFileList\">\r\n                                        <a class=\"el-upload-list__item-name\"><i class=\"el-icon-document\"></i>{{file.name}}</a>\r\n                                        <label class=\"el-upload-list__item-status-label\">\r\n                                            <i class=\"el-icon-upload-success el-icon-circle-check\"></i>\r\n                                        </label>\r\n\r\n                                        <el-tooltip class=\"item\" effect=\"light\"  placement=\"right\">\r\n                                            <div class=\"prism-editor-wrap\"  slot=\"content\">\r\n                                                <prism-editor class=\"my-editor\" v-model=\"code\" :highlight=\"highlighter\" line-numbers readonly></prism-editor>\r\n                                            </div>\r\n                                            <i class=\"el-icon-close\" style=\"width: 20px;\" @click=\"deleteNodeListFile(file.nodeIdx, file.id)\" @mouseover=\"handleMouseOver(file)\"></i>\r\n                                        </el-tooltip>\r\n                                    </li>\r\n                                </ul>\r\n\r\n                            </div>\r\n                            <div class=\"box-operator clearfix\">\r\n                                <el-col :span=\"12\">\r\n                                    <el-badge :value=\"getCombineFileNum\" class=\"large-btn\" :hidden=\"getCombineFileNum > 0 ? false : true\" >\r\n                                        <el-button type=\"primary\" v-show=\"form.ready\" size=\"medium\" class=\"large-btn\" @click=\"combineFile\">合并</el-button>\r\n                                        <el-button v-show=\"!form.ready\" type=\"primary\"  size=\"medium\" class=\"large-btn\" :loading=\"true\">合并中</el-button>\r\n                                    </el-badge>\r\n                                </el-col>\r\n                                <el-col :span=\"12\"><el-button type=\"danger\" size=\"medium\" class=\"large-btn\" @click=\"clearBoxFileList\">清空</el-button></el-col>\r\n                            </div>\r\n\r\n                        </el-card>\r\n                    </el-col>\r\n\r\n                    <el-col :span=\"14\">\r\n                        <el-form ref=\"form\" :rules=\"formRules\" :model=\"form\" label-width=\"150px\">\r\n                            <el-form-item label=\"使用替换\">\r\n                                <el-switch v-model=\"form.delivery\">\r\n                                </el-switch>\r\n                                <span style=\"color: #F56C6C;margin-left: 5px;display: inline-block;\">使用已经替换的程式或者重新上传程式</span>\r\n                            </el-form-item>\r\n\r\n                            <el-form-item label=\"文件头删除行数\" prop=\"fileHeaderDeletedLine\">\r\n                                <el-select v-model=\"form.fileHeaderDeletedLine\"  placeholder=\"请选择\" >\r\n                                    <el-option\r\n                                            v-for=\"num in 20\"\r\n                                            :key=\"num\"\r\n                                            :label=\"num\"\r\n                                            :value=\"num\">\r\n                                    </el-option>\r\n                                </el-select>\r\n                            </el-form-item>\r\n\r\n                            <el-form-item label=\"文件尾删除行数\" prop=\"fileFooterDeletedLine\">\r\n                                <el-select v-model=\"form.fileFooterDeletedLine\"  placeholder=\"请选择\" >\r\n                                    <el-option\r\n                                            v-for=\"num in 20\"\r\n                                            :key=\"num\"\r\n                                            :label=\"num\"\r\n                                            :value=\"num\">\r\n                                    </el-option>\r\n                                </el-select>\r\n                            </el-form-item>\r\n\r\n                            <el-form-item label=\"文件头增加\" prop=\"fileHeader\">\r\n                                <el-input type=\"textarea\" v-model=\"form.fileHeader\"></el-input>\r\n                            </el-form-item>\r\n\r\n\r\n                            <el-form-item label=\"文件尾增加\" prop=\"fileFooter\" class=\"clearfix\">\r\n                                <el-col :span=\"14\">\r\n                                    <el-input type=\"textarea\" v-model=\"form.fileFooter\" :autosize=\"{ minRows: 6}\"></el-input>\r\n                                </el-col>\r\n\r\n                                <el-col :span=\"10\">\r\n                                    <el-input placeholder=\"模板名\" class=\"margin-bottom-10\" v-model=\"form.templateName\"></el-input>\r\n\r\n                                    <el-button icon=\"el-icon-document\" @click=\"showTemplate\">选择模板</el-button>\r\n                                    <el-button icon=\"el-icon-document-add\" type=\"primary\" plain @click=\"saveTemplate\">保存模板</el-button>\r\n                                </el-col>\r\n                            </el-form-item>\r\n\r\n                            <el-form-item label=\"串联程式新名\" prop=\"fileName\">\r\n                                <el-input placeholder=\"串联程式新名\" v-model=\"form.fileName\" class=\"input-with-select\">\r\n                                    <el-select v-model=\"form.fileSuffix\" slot=\"append\" placeholder=\"请选择\" prop=\"fileSuffix\">\r\n                                        <el-option\r\n                                                v-for=\"item in form.fileSuffixOptions\"\r\n                                                :key=\"item.value\"\r\n                                                :label=\"item.name\"\r\n                                                :value=\"item.value\">\r\n                                        </el-option>\r\n                                    </el-select>\r\n                                </el-input>\r\n\r\n                            </el-form-item>\r\n\r\n                            <el-form-item label=\"文件保存路径\" prop=\"filePath\">\r\n                                <el-input placeholder=\"文件保存路径\" v-model=\"form.filePath\" class=\"input-with-select\" readonly>\r\n                                </el-input>\r\n                            </el-form-item>\r\n\r\n                            <el-form-item>\r\n                                <!--<el-button v-show=\"form.ready\" type=\"primary\" @click=\"combineFile\">立即合并</el-button>\r\n                                <el-button v-show=\"!form.ready\" type=\"primary\" :loading=\"true\">合并中</el-button>\r\n                                <el-button @click=\"formReset()\">取消</el-button>-->\r\n                            </el-form-item>\r\n                        </el-form>\r\n\r\n                    </el-col>\r\n\r\n                    <el-dialog title=\"选择文件尾模板\" :visible.sync=\"dialogFormVisible\">\r\n                        <el-form >\r\n                            <div v-for=\"(item,key) in getTemplate\">\r\n                                <el-form-item label=\"\" prop=\"fileName\">\r\n                                    <el-col :span=\"23\">\r\n                                        <el-radio v-model=\"form.selectedTemplate\" :label=\"key\" border class=\"s-radio clearfix\">\r\n                                            <el-col :span=\"13\" :offset=\"1\">\r\n                                                <el-input placeholder=\"文件尾增加内容\" v-model=\"item.value\" type=\"textarea\" :autosize=\"{ minRows: 6}\">\r\n\r\n                                                </el-input>\r\n                                            </el-col>\r\n\r\n                                            <el-col :span=\"10\" >\r\n                                                <el-input   placeholder=\"模板名称\" v-model=\"item.name\" class=\"s-input\"></el-input>\r\n\r\n                                                <div>\r\n                                                    <el-input placeholder=\"文件保存路径\" v-model=\"item.path\" class=\"input-with-select mt-10\" readonly >\r\n                                                        <el-button slot=\"append\" icon=\"el-icon-folder\" type=\"success\" @click=\"openFolder(key)\"></el-button>\r\n                                                    </el-input>\r\n                                                </div>\r\n                                            </el-col>\r\n                                        </el-radio>\r\n                                    </el-col>\r\n\r\n                                    <el-col :span=\"1\"  title=\"删除\" >\r\n                                        <i class=\"el-icon-close t-close\" @click=\"deleteTemplate(key)\"></i>\r\n                                    </el-col>\r\n\r\n                                </el-form-item>\r\n                            </div>\r\n\r\n                        </el-form>\r\n\r\n                        <div slot=\"footer\" class=\"dialog-footer\">\r\n                            <el-button  @click=\"addTemplate\">增 加</el-button>\r\n                            <el-button type=\"primary\" @click=\"dialogSaveTemplate\">保 存</el-button>\r\n                        </div>\r\n                    </el-dialog>\r\n\r\n<!--                    选择文件夹-->\r\n                    <el-dialog title=\"选择保存的目录\" :visible.sync=\"dialogFolderSelectVisible\">\r\n                        <div>\r\n                            <span class=\"folder-select-title\">当前选中: </span>\r\n                            <span v-show=\"getCurFolder.length == 0\" style=\"color:red;\">未选中文件夹</span>\r\n                            <span v-show=\"getCurFolder.length > 0\">{{getCurFolder}}</span>\r\n                        </div>\r\n                        <div class=\"folder-content\">\r\n                            <v-folder :data=\"folderData\"  :ajax=\"ajax\" :conf=\"folderConfig\" @change=\"folderChange\"></v-folder>\r\n                        </div>\r\n                        <div slot=\"footer\" class=\"dialog-footer\">\r\n                            <el-button type=\"primary\" @click=\"dialogSaveFolder\">保 存</el-button>\r\n                        </div>\r\n                    </el-dialog>\r\n\r\n                </el-tab-pane>\r\n\r\n                <el-tab-pane label=\"串联历史\" name=\"history\" style=\"margin-top: 10px;\" class=\"history-box\">\r\n                    <span slot=\"label\">串联历史<el-badge :value=\"combineHisNum\" class=\"large-btn\" :hidden=\"combineHisNum > 0 ? false : true\" ></el-badge></span>\r\n                    <el-empty v-if=\"combineHisNum == 0\" description=\"没有历史记录\"></el-empty>\r\n                    <el-card v-if=\"combineHisNum > 0\" class=\"box-card wrap-card\" >\r\n                        <div slot=\"header\" class=\"clearfix\">\r\n                            <el-button style=\"float: right;cursor: pointer;\" type=\"danger\" @click=\"delAllHis()\">全部删除</el-button>\r\n                        </div>\r\n                        <div  class=\"text item\">\r\n                            <el-card class=\"box-card mt-10\" v-for=\"(his, key) in getCombineHisList\" shadow=\"hover\">\r\n                                <div slot=\"header\" class=\"clearfix cb-his-card-header\">\r\n                                    <span>[{{his.create_at}}]</span>\r\n                                    <span style=\"margin-left:10px;\">{{his.name}}</span>\r\n                                    <el-button style=\"float: right; padding: 3px 0; color:red;cursor: pointer;\" type=\"text\" @click=\"delHis(key)\">删除</el-button>\r\n                                </div>\r\n                                <div v-for=\"child in his.children\" class=\"text item\">\r\n                                    {{child}}\r\n                                </div>\r\n                            </el-card>\r\n                        </div>\r\n                    </el-card>\r\n                    \r\n                </el-tab-pane>\r\n            </el-tabs>\r\n        </el-col>\r\n    </el-row>\r\n</template>\r\n<script>\r\n    import ElTableDraggable from 'element-ui-el-table-draggable';\r\n    const iconv = require('iconv-lite');\r\n    const jschardet = require(\"jschardet\")\r\n    import { invoke, window } from '@tauri-apps/api';\r\n\r\n    // import highlighting library (you can use any library you want just return html string)\r\n    import { highlight, languages } from 'prismjs/components/prism-core';\r\n    import 'prismjs/components/prism-clike';\r\n    import 'prismjs/components/prism-javascript';\r\n    import 'prismjs/themes/prism-tomorrow.css'; // import syntax highlighting styles\r\n\r\n    export default {\r\n        data() {\r\n            return {\r\n                showFlag: true,\r\n                code: \"\",\r\n                plugins: ['line-numbers'],\r\n                activeName: 'first',\r\n                winTop: '',\r\n                cacheFile: 'web.conf.json',\r\n                isWinOs: false,\r\n                combineHis: [\r\n                    // {name: 'test', create_at: '2023-01-01 22:22:22', children: ['a.txt', 'b.txt']},\r\n                    // {name: 'test', create_at: '2023-01-01 22:22:22', children: ['a.txt', 'b.txt']},\r\n                    // {name: 'test', create_at: '2023-01-01 22:22:22', children: ['a.txt', 'b.txt']}\r\n                ],\r\n                folderData: {\r\n                    // root\r\n                    sourceDir: '/',\r\n                    // children\r\n                    files: [],\r\n                    dirs: []\r\n                },\r\n                folderData2: {\r\n                    sourceDir: 'root',\r\n                    dirs: [{\r\n                        sourceDir: 'subroot-1',\r\n                        dirs: ['empty 1', 'empty 2', 'empty 3'],\r\n                        files: ['file1234', 'file5678', 'filexyzw']\r\n                    }, {\r\n                        sourceDir: 'subroot-2',\r\n                        dirs: ['empty 1', 'empty 2', 'empty 3'],\r\n                        files: ['file1234', 'file5678', 'filexyzw']\r\n                    }, {\r\n                        sourceDir: 'subroot-3',\r\n                        dirs: ['empty 1', 'empty 2', 'empty 3'],\r\n                        files: ['file1234', 'file5678', 'filexyzw']\r\n                    }],\r\n                    files: ['a.js', 'b.js', 'c.js']\r\n                },\r\n\r\n                folderConfig: {\r\n                    // tree node name\r\n                    node: 'sourceDir',\r\n                    // KEY NAME of dirs/branches/parents etc.. .\r\n                    branch: 'dirs',\r\n                    // KEY NAME of  files/leafs/children etc...\r\n                    leaf: 'files'\r\n                },\r\n                ajax: (node) => {\r\n\r\n                    return this.readFolder(node);\r\n\r\n                    console.log(node)\r\n                    return {\r\n                        sourceDir: 'subroot-99',\r\n                        dirs: [\"xxx\", 'empty 2', 'empty 3'], ///仅支持当前层\r\n                        files: ['file1234', 'file5678', 'filexyzw']\r\n                    }\r\n                },\r\n\r\n                operatorTemplateIdx: 0,\r\n\r\n                dialogFolderSelectVisible: false,\r\n                dialogFormVisible: false,\r\n                selectedFolder: [],\r\n                fileList: [],\r\n                tmpFileNames: [],\r\n                nodeList: [],\r\n                nodeNum: 2,\r\n                replaceHis: [],\r\n                specialFileList: [],\r\n                specialBoxFileList: [\r\n                ],\r\n                specialKey: 99,\r\n                specialBoxKey: 98,\r\n                form: {\r\n                    fileHeader: '',\r\n                    fileFooter: '',\r\n                    fileName: '',\r\n                    filePath: '',\r\n                    fileHeaderDeletedLine: 1,\r\n                    fileFooterDeletedLine: 1,\r\n                    fileSuffix: \".nc\",\r\n                    fileSuffixOptions: [\r\n                        {value: \".nc\", name: \".nc\"},\r\n                        {value: \".pim\", name: \".pim\"},\r\n                    ],\r\n                    templateList: [],\r\n                    selectedTemplate: 0,\r\n                    templateName: '',\r\n                    ready: true,\r\n                    delivery: false,\r\n                },\r\n                dragOptions:{\r\n                    animation: 120,\r\n                    scroll: true,\r\n                    group: 'sortlist',\r\n                    ghostClass: 'ghost-style'\r\n                },\r\n                curId: 0,\r\n                combineFileList : [\r\n                ],\r\n\r\n                dragList: [],\r\n                dragConfig: {\r\n                    optionVal: 0,\r\n                    options: [\r\n                        {value: 0, label: \"文件头删除行数\"},\r\n                        {value: 1, label: \"文件尾删除行数\"}\r\n                    ],\r\n\r\n                    setVal: 1,\r\n                },\r\n\r\n                formRules: {\r\n                    fileHeader: [\r\n                        { required: true, message: '请输入文件头', trigger: 'blur' },\r\n                    ],\r\n                    fileFooter: [\r\n                        { required: true, message: '请输入文件尾', trigger: 'change' }\r\n                    ],\r\n                    fileName: [\r\n                        { required: true, message: '请输入完整文件名', trigger: 'change', validator: (rule, value, callback) => {\r\n                            if(!this.form.fileName) {\r\n                                return callback(new Error('请输入完整文件名'));\r\n                            }\r\n\r\n                            if(this.form.fileSuffix === '') {\r\n                                return callback(new Error('请选择文件后缀'));\r\n                            }\r\n\r\n                            callback();\r\n                        }}\r\n                    ],\r\n                    fileSuffix: [\r\n                        { required: true, message: '请选择文件后缀', trigger: 'change' }\r\n                    ],\r\n                    filePath: [\r\n                        { required: true, message: '请在模板里面设置文件路径', trigger: 'blur' }\r\n                    ],\r\n\r\n                }\r\n            };\r\n        },\r\n        components:{\r\n            ElTableDraggable\r\n        },\r\n        computed: {\r\n            getCombineFileNum: function() {\r\n                if(this.form.delivery) {\r\n                    return this.totalNum;\r\n                }\r\n                return this.specialBoxNum;\r\n            },\r\n            getCurFolder: function() {\r\n                return this.selectedFolder.join(',');\r\n            },\r\n            replaceFlag: function () {\r\n                return (idx) => {\r\n                    if (!this.nodeList.hasOwnProperty(idx)) {\r\n                        return false;\r\n                    }\r\n\r\n                    let node = this.nodeList[idx];\r\n                    let replaceKey = this.createReplaceKey(node.search, node.replace);\r\n                    return node.replaceHis.indexOf(replaceKey) != -1;\r\n                };\r\n            },\r\n            totalNum: function() {\r\n                let num = 0;\r\n                this.nodeList.map(node => {\r\n                    num += node.fileList.length;\r\n                });\r\n\r\n                return num;\r\n            },\r\n            combineHisNum: function() {\r\n                return this.combineHis.length;\r\n            },\r\n            specialNum: function() {\r\n                return this.specialFileList.length;\r\n            },\r\n            specialBoxNum: function() {\r\n                return this.specialBoxFileList.length;\r\n            },\r\n\r\n            getTemplate: function() {\r\n                return this.form.templateList;\r\n            },\r\n\r\n            getCombineHisList: function() {\r\n                return this.combineHis.sort(function(x, y) {\r\n                    return y.create_at.localeCompare(x.create_at);\r\n                });\r\n            },\r\n\r\n            getFileList: {\r\n                get() {\r\n                    let fileList = [];\r\n\r\n                    if(this.form.delivery) {\r\n                        this.nodeList.map((node, nodeIdx) => {\r\n                            node.fileList.map((file, fileIdx) => {\r\n                                file.nodeIdx = nodeIdx;\r\n                                file.fileIdx = fileIdx;\r\n                                fileList.push(file);\r\n                            });\r\n                        });\r\n                    } else {\r\n                        //debugger\r\n                        //fileList.push(...this.specialFileList);\r\n                    }\r\n\r\n                    return fileList;\r\n                },\r\n                set(value) {\r\n                    console.warn(value)\r\n                },\r\n            },\r\n            getFileBadge: function() {\r\n                return (rawName) => {\r\n                    return rawName + (this.totalNum > 0 ? '<el-badge value=\"' + this.totalNum + '\" class=\"large-btn\"  />' : '');\r\n                };\r\n            },\r\n        },\r\n\r\n        watch: {\r\n            //nodeList: {\r\n            // immediate: true,\r\n            // //deep: true,\r\n            // handler(nodeList) {\r\n            //\r\n            // }\r\n            //},\r\n            \"form.selectedTemplate\": {\r\n                immediate: false,\r\n                handler(value) {\r\n                    this.selectTemplate(value);\r\n                },\r\n            }\r\n        },\r\n        created() {\r\n            //this.initParams();\r\n        },\r\n        mounted() {\r\n            this.initNodeList();\r\n            this.initParams();\r\n            this.handleWindowTop();\r\n\r\n            if(navigator.userAgent.toLowerCase().indexOf('windows') != -1) {\r\n                this.isWinOs = true;\r\n                this.folderData.dirs = ['C:/', 'D:/', 'E:/', 'F:/'];\r\n            }\r\n        },\r\n\r\n        methods: {\r\n            handleMouseOver(file) {\r\n                this.code = file.content;\r\n            },\r\n            highlighter(code) {\r\n                //debugger\r\n                console.log(':highlight=\"highlighter\"')\r\n                console.log(code)\r\n                console.log(languages)\r\n                return highlight(code, languages.plaintext); // languages.<insert language> to return html with markup\r\n            },\r\n             handleWindowTop() {\r\n                let curWin = window.getCurrent();\r\n                if (this.winTop === '窗口置顶') {\r\n                    curWin.setAlwaysOnTop(true);\r\n                    this.winTop = '取消置顶';\r\n                } else {\r\n                    curWin.setAlwaysOnTop(false);\r\n                    this.winTop = '窗口置顶';\r\n                }\r\n            },\r\n            delHis(idx) {\r\n                //删除功能\r\n                this.combineHis.splice(idx, 1);\r\n                console.log(idx,  this.combineHis)\r\n            },\r\n            delAllHis() {\r\n                this.combineHis = [];\r\n            },\r\n            deleteNodeListFile(nodeIdx, fileId) {\r\n                let fileList = this.nodeList[nodeIdx].fileList.slice(0);\r\n                fileList.map(file => {\r\n                    if(file.id == fileId) {\r\n                        this.closeUploadedFile(nodeIdx, file, true)\r\n                    }\r\n                });\r\n            },\r\n            dialogSaveFolder() {\r\n                this.dialogFolderSelectVisible = false;\r\n                this.form.templateList[this.operatorTemplateIdx]['path'] = this.selectedFolder.join(',');\r\n                this.updateLocalStorage();\r\n            },\r\n            openFolder(idx) {\r\n                this.dialogFolderSelectVisible = true;\r\n                this.operatorTemplateIdx = idx;\r\n            },\r\n            basename(str) {\r\n                var idx = str.lastIndexOf('/')\r\n                idx = idx > -1 ? idx : str.lastIndexOf('\\\\')\r\n                if (idx < 0) {\r\n                    return str\r\n                }\r\n                return str.substring(idx + 1);\r\n            },\r\n\r\n            readFolder(node) {\r\n                return this.wmcReadDir(node.path).then(res => {\r\n                    let realPath = {\r\n                        sourceDir: this.basename(node.path),\r\n                        dirs: [], ///仅支持当前层\r\n                        files: []\r\n                    };\r\n                    res.map(item => {\r\n                        if(item.is_dir) {\r\n                            realPath.dirs.push(this.basename(item.path));\r\n                        }\r\n                    });\r\n\r\n                    return realPath;\r\n                });\r\n            },\r\n\r\n            writeContent(path, content) {\r\n                return this.wmcReadDir(node.path).then(res => {\r\n                    let realPath = {\r\n                        sourceDir: this.basename(node.path),\r\n                        dirs: [], ///仅支持当前层\r\n                        files: []\r\n                    };\r\n                    res.map(item => {\r\n                        if(item.is_dir) {\r\n                            realPath.dirs.push(this.basename(item.path));\r\n                        }\r\n                    });\r\n\r\n                    return realPath;\r\n                });\r\n            },\r\n\r\n            folderChange(value) {\r\n                console.warn(value)\r\n                if(this.isWinOs) {\r\n                    value = value.map(res => {\r\n                        return res.slice(1);\r\n                    });\r\n                }\r\n\r\n                this.selectedFolder = value;\r\n            },\r\n\r\n            wmcReadDir(path) {\r\n                return invoke('wmc_read_dir', { path: path }).then(res => {\r\n                    console.log(res)\r\n\r\n                    let content = JSON.parse(res)\r\n                    if(!content || content.length == 0) {\r\n                        return [];\r\n                    }\r\n\r\n                    console.warn(content)\r\n                    content = content.map(item => {\r\n                        let parsed = item.split(',');\r\n                        return {\r\n                            path: this.fixWinsDir(parsed[0]),\r\n                            is_dir: parsed[1] == 'true' ? true : false,\r\n                        };\r\n                    });\r\n\r\n                    return content;\r\n                });\r\n            },\r\n\r\n            fixWinsDir(dir) {\r\n                if(!this.isWinOs) {\r\n                    return dir;\r\n                }\r\n\r\n                dir = dir.replace(new RegExp(\"//\", \"g\"), '/');\r\n                dir = dir.replace(new RegExp(\"\\\\\\\\\", \"g\"), '/');\r\n\r\n                return dir;\r\n            },\r\n\r\n            wmcWrite(path, content) {\r\n                return invoke('wmc_write', { path: path , content: content}).then(res => {\r\n                    console.log('wmc_write: ' + res)\r\n\r\n                    return JSON.parse(res);\r\n                });\r\n            },\r\n\r\n            //保存到本地文件\r\n            cacheRead() {\r\n                return this.wmcRead(this.cacheFile);\r\n            },\r\n\r\n            cacheWrite(json) {\r\n                this.cacheRead().then(res => {\r\n                    res = typeof res == 'object' ? res : {};\r\n                    res = Object.assign({}, res, json);\r\n                    this.wmcWrite(this.cacheFile, JSON.stringify(res))\r\n                })\r\n            },\r\n\r\n            wmcRead(path) {\r\n                return invoke('wmc_read', { path: path}).then(res => {\r\n                    console.log('wmc_read: ' + res)\r\n\r\n                    return res;\r\n                });\r\n            },\r\n\r\n            triggerFile(event) {\r\n                console.log(event.target.files)\r\n            },\r\n            deleteTemplate(idx)  {\r\n\r\n                this.form.templateList = this.form.templateList.filter((t,key) => {return key != idx;});\r\n                console.log(this.form.templateList.length)\r\n                console.log(this.form.templateList)\r\n                if(this.form.templateList == null) {\r\n                    this.form.templateList = [];\r\n                }\r\n            },\r\n            initParams() {\r\n                //初始化的时候，获取缓存里面的修改历史\r\n                let combineHisCache = localStorage.getItem('combine-his');\r\n                combineHisCache = JSON.parse(combineHisCache);\r\n                this.combineHis = combineHisCache == null ? [] : combineHisCache;\r\n\r\n                let formCache = localStorage.getItem('form');\r\n                formCache = JSON.parse(formCache);\r\n                if(!formCache) {\r\n                    return \"\";\r\n                }\r\n\r\n                if(formCache != null) {\r\n                    for(let key in formCache) {\r\n                        this.form[key] = formCache[key];\r\n                    }\r\n                }\r\n\r\n                return false;\r\n                this.cacheRead().then(res => {\r\n                    if(!res) {\r\n                        return \"\";\r\n                    }\r\n\r\n                    let formCache = JSON.parse(res);\r\n                    console.log(formCache)\r\n                    if(formCache != null) {\r\n                        for(let key in formCache) {\r\n                            this.form[key] = formCache[key];\r\n                        }\r\n                    }\r\n                });\r\n            },\r\n            dialogSaveTemplate() {\r\n                this.dialogFormVisible = false;\r\n                this.selectTemplate(this.form.selectedTemplate);\r\n                this.updateLocalStorage();\r\n            },\r\n            updateLocalStorage() {\r\n                localStorage.setItem('form', JSON.stringify(this.form));\r\n\r\n                //存储修改历史\r\n                localStorage.setItem('combine-his', JSON.stringify(this.combineHis));\r\n                //this.cacheWrite(this.form)\r\n            },\r\n            selectTemplate(idx) {\r\n                this.form.templateList = this.form.templateList.filter(t => t); // remove null\r\n                if(!this.form.templateList.hasOwnProperty(idx)) {\r\n                    return false;\r\n                }\r\n\r\n                let cur = this.form.templateList[idx];\r\n                this.form.fileFooter = cur.value;\r\n                this.form.templateName = cur.name;\r\n                this.form.filePath = cur.path;\r\n            },\r\n\r\n            addTemplate() {\r\n                let template = {name: '', value: '', path: ''};\r\n                this.form.templateList.push(template);\r\n            },\r\n\r\n            showTemplate() {\r\n                this.dialogFormVisible = true;\r\n            },\r\n\r\n            saveTemplate() {\r\n                let template = {\r\n                    value: this.form.fileFooter,\r\n                    name: this.form.templateName,\r\n                };\r\n\r\n                if(!template.value) {\r\n                    this.$message.info('请输入文件尾内容');\r\n                    return false;\r\n                }\r\n\r\n                if(!template.name) {\r\n                    this.$message.info('请输要保存模板名称');\r\n                    return false;\r\n                }\r\n\r\n                for(let idx in this.form.templateList)  {\r\n                    if(this.form.templateList[idx].name == template.name) {\r\n                        this.form.templateList[idx].value = template.value;\r\n                        this.$message.success('模板保存成功');\r\n                        this.updateLocalStorage();\r\n                        return  false;\r\n                    }\r\n                }\r\n\r\n                this.form.templateList.push(template);\r\n                this.updateLocalStorage();\r\n            },\r\n\r\n            combineFile() {\r\n                this.$refs['form'].validate((valid) => {\r\n                    if (!valid) {\r\n                        return false;\r\n                    }\r\n\r\n                    let rawList = [];\r\n                    let rawIds = [];\r\n\r\n                    if(this.form.delivery) {\r\n                        this.nodeList.map(node => {\r\n                            node.fileList.map(file => {\r\n                                rawIds.push(file.id);\r\n                                rawList.push(file);\r\n                            });\r\n                        });\r\n                    } else {\r\n                        rawList.push(...this.specialFileList);\r\n                        rawList.push(...this.specialBoxFileList);\r\n                    }\r\n\r\n                    if(rawList.length == 0) {\r\n                        this.$message.info('请上传要合并的文件');\r\n                        return false;\r\n                    }\r\n\r\n                    let promiseList = [];\r\n                    let combineList = {name: '', create_at: this.getDatetime(), children: []};\r\n                    rawList.map(file => {\r\n                        //debugger\r\n                        /*if(this.form.delivery && rawIds.indexOf(file.id) == -1) {\r\n                            return false;\r\n                        }\r\n\r\n                        if(!this.form.delivery && rawIds.indexOf(file.id) != -1) {\r\n                            return false;\r\n                        }*/\r\n\r\n                        //合并的源文件列表\r\n                        combineList.children.push(file.name);\r\n\r\n                        let p = this.readFile(file, res => {\r\n                            //debugger\r\n                            console.warn('***********res***********')\r\n                            console.warn(res)\r\n                            res = res.split(\"\\n\").filter(res => res);\r\n                            res.splice(0, this.form.fileHeaderDeletedLine);\r\n                            res.splice(res.length - this.form.fileFooterDeletedLine, this.form.fileFooterDeletedLine);\r\n                            return res.join(\"\\n\");\r\n                        });\r\n\r\n                        promiseList.push(p);\r\n                    });\r\n\r\n                    if(promiseList.length == 0) {\r\n                        this.$message.info('请上传要合并的文件11');\r\n                        return false;\r\n                    }\r\n\r\n                    this.form.ready = false;\r\n                    Promise.all([...promiseList]).then(res => {\r\n                        console.log(res)\r\n                        res.unshift(this.fixTextArea(this.form.fileHeader));\r\n                        res.push(this.fixTextArea(this.form.fileFooter));\r\n                        res = res.filter(res => res);\r\n                        console.log(\"raw res: \", res)\r\n                        res = res.join(\"\\n\");\r\n\r\n                        console.log(res)\r\n                        this.form.ready = true;\r\n                        //this.downloadFileByContent(res, this.form.fileName + this.form.fileSuffix);\r\n                        this.wmcWrite(this.getFormFilePath(), res).then(res => {\r\n                            console.log('合并结果', res);\r\n                            if(res) {\r\n                                this.$message.success(\"合并成功，文件：\" + this.getFormFilePath());\r\n\r\n                                combineList.name = this.getFormFilePath();\r\n\r\n                                //debug \r\n                                console.log(combineList)\r\n                                this.combineHis.push(combineList);\r\n                                this.updateLocalStorage();\r\n\r\n                                return true;\r\n                            }\r\n\r\n                            this.$message.error(\"合并失败，文件：\" + this.getFormFilePath() + ', 请检查文件路径是否存在或者是否有写入权限');\r\n                        })\r\n                    });\r\n\r\n                    console.log('content')\r\n                });\r\n            },\r\n\r\n            fixTextArea(content) {\r\n                if(!this.isWinOs) {\r\n                    return content;\r\n                }\r\n\r\n                return content.replace(new RegExp(\"\\n\", \"g\"), \"\\r\\n\");\r\n            },\r\n\r\n            combineFile_bak() {\r\n                this.$refs['form'].validate((valid) => {\r\n                    if (!valid) {\r\n                        return false;\r\n                    }\r\n\r\n                    let rawList = [];\r\n                    let rawIds = [];\r\n                    this.nodeList.map(node => {\r\n                        node.fileList.map(file => {\r\n                            rawIds.push(file.id);\r\n                            rawList.push(file);\r\n                        });\r\n                    });\r\n\r\n                    rawList.push(...this.specialFileList);\r\n                    rawList.push(...this.specialBoxFileList);\r\n\r\n                    if(this.dragList.length != rawList.length) {\r\n                        this.dragList = rawList;\r\n                    }\r\n\r\n                    if(this.dragList.length == 0) {\r\n                        this.$message.info('请上传要合并的文件11');\r\n                        return false;\r\n                    }\r\n\r\n                    let promiseList = [];\r\n                    this.dragList.map(file => {\r\n                        //debugger\r\n                        /*if(this.form.delivery && rawIds.indexOf(file.id) == -1) {\r\n                            return false;\r\n                        }\r\n\r\n                        if(!this.form.delivery && rawIds.indexOf(file.id) != -1) {\r\n                            return false;\r\n                        }*/\r\n\r\n                        let p = this.readFile(file, res => {\r\n                            res = res.split(\"\\n\").filter(res => res);\r\n                            res.splice(0, file.headerDeleteLine);\r\n                            res.splice(res.length - file.footerDeleteLine, file.footerDeleteLine);\r\n                            return res.join(\"\\n\");\r\n                        });\r\n\r\n                        promiseList.push(p);\r\n                    });\r\n\r\n                    if(promiseList.length == 0) {\r\n                        this.$message.info('请上传文件33');\r\n                        return false;\r\n                    }\r\n\r\n                    this.form.ready = false;\r\n                    Promise.all([...promiseList]).then(res => {\r\n                        console.log(res)\r\n                        res.unshift(this.form.fileHeader);\r\n                        res.push(this.form.fileFooter);\r\n                        res = res.filter(res => res);\r\n                        res = res.join(\"\\n\");\r\n\r\n                        console.log(res)\r\n                        this.form.ready = true;\r\n                        //this.downloadFileByContent(res, this.form.fileName + this.form.fileSuffix);\r\n                        this.wmcWrite(this.getFormFilePath(), res).then(res => {\r\n                            console.log('合并结果', res);\r\n                            if(res) {\r\n                                this.$message.success(\"合并成功，文件：\" + this.getFormFilePath());\r\n                                return true;\r\n                            }\r\n\r\n                            this.$message.error(\"合并失败，文件：\" + this.getFormFilePath() + ', 请检查文件路径是否存在或者是否有写入权限');\r\n                        })\r\n                    });\r\n\r\n                    console.log('content')\r\n                });\r\n            },\r\n\r\n            getFormFilePath() {\r\n                return this.form.filePath + '/' + this.form.fileName + this.form.fileSuffix;\r\n            },\r\n\r\n            test(flag) {\r\n                return new Promise((resolve, reject) => {\r\n                    let time = Math.ceil(Math.random() * 10000);\r\n                    console.warn('执行 ' + flag);\r\n                    setTimeout(() => {\r\n                        resolve(time + '-' + flag);\r\n                    }, time);\r\n                });\r\n            },\r\n        \r\n\r\n            readFile(file, callback) {\r\n                return new Promise((resolve, reject) => {\r\n                    let fileReader = new FileReader();\r\n                    fileReader.onloadend =  (event) => {\r\n                        console.warn(event)\r\n                        console.warn(this.detectCharset(event.target.result))\r\n                        resolve(callback(this.fileContentDecode(event.target.result)));\r\n                    };\r\n\r\n                    fileReader.readAsBinaryString(file.raw);\r\n                });\r\n            },\r\n            fileConfigAdd() {\r\n                this.dispatchFileConfig(true);\r\n            },\r\n\r\n            fileConfigReduce() {\r\n                this.dispatchFileConfig(false);\r\n            },\r\n\r\n            dispatchFileConfig(isAdd = true) {\r\n                if(this.form.delivery) {\r\n                    this.nodeList.map(node => {\r\n                        node.fileList.map(file => {\r\n                            this.doUpdateDeletedLine(file, isAdd);\r\n                        });\r\n                    });\r\n                } else {\r\n                    this.specialFileList.map(file => {\r\n                        this.doUpdateDeletedLine(file, isAdd);\r\n                    });\r\n                }\r\n            },\r\n\r\n            doUpdateDeletedLine(file, isAdd = true) {\r\n                let key = this.dragConfig.optionVal == 0 ? 'headerDeleteLine' : 'footerDeleteLine';\r\n                file[key] = file[key] == undefined ? 0 : file[key];\r\n                if(isAdd) {\r\n                    file[key] += this.dragConfig.setVal;\r\n                } else {\r\n                    file[key] -= this.dragConfig.setVal;\r\n                }\r\n\r\n                file[key] = file[key] < 0 ? 0 : file[key];\r\n                this.updateDeletedLine(file.id, key, file[key]);\r\n            },\r\n\r\n            updateDeletedLine(id, mode, value) {\r\n                let key = this.createDeleteKey(id, mode);\r\n                this.$refs[key].setCurrentValue(value);\r\n            },\r\n\r\n            dragChange(log) {\r\n                this.dragList = log.list;\r\n                console.log(log)\r\n\r\n            },\r\n            formReset() {\r\n                this.$refs.form.resetFields();\r\n                for(let key in this.form) {\r\n                    if(key == 'fileSuffixOptions') {\r\n                        continue;\r\n                    }\r\n\r\n                    if(this.form.hasOwnProperty(key)) {\r\n                        this.form[key] = key == 'ready' || key == \"delivery\" ? true : '';\r\n                    }\r\n                }\r\n            },\r\n            removeHandle(event){\r\n                console.log(event);\r\n                this.$message.success(`从 ${event.from.id} 移动到 ${event.to.id} `);\r\n            },\r\n            addNode() {\r\n                this.nodeList.push(this.initNode());\r\n            },\r\n\r\n            batchReplace() {\r\n                this.nodeList.map((node, idx) => {\r\n                    if(node.fileList.length == 0) {\r\n                        return false;\r\n                    }\r\n\r\n                    this.doReplace(idx, true);\r\n                });\r\n            },\r\n\r\n            batchDownload() {\r\n                this.nodeList.map((node, idx) => {\r\n                    if(node.fileList.length == 0) {\r\n                        return false;\r\n                    }\r\n\r\n                    this.downloadFile(idx);\r\n                });\r\n            },\r\n\r\n            clearBoxFileList() {\r\n                if(this.form.delivery) {\r\n                    for(let idx in this.nodeList) {\r\n                        this.clearSearchReplace(idx);\r\n                    }\r\n                } else {\r\n                    let deletedList = this.specialBoxFileList.slice(0);\r\n                    deletedList.map((file, key) => {\r\n                        this.closeUploadedFile(this.specialBoxKey, file, false);\r\n                    })\r\n                }\r\n            },\r\n\r\n            clearSearchReplace(idx) {\r\n\r\n                //debugger\r\n                if(this.nodeList[idx].fileList.length == 0) {\r\n                    return false;\r\n                }\r\n\r\n                let deletedList = this.nodeList[idx].fileList.slice(0);\r\n                console.log(deletedList)\r\n                deletedList.map((file, key) => {\r\n                    //debugger\r\n                    console.warn(file.name, key)\r\n                    this.closeUploadedFile(idx, file)\r\n                })\r\n\r\n                /*let node = this.initNode();\r\n                for(let key in node) {\r\n                    this.nodeList[idx][key] = node[key];\r\n                }*/\r\n            },\r\n\r\n            closeUploadedFile(idx, file, isMulti = true) {\r\n                let ref = this.$refs[this.createUploadKey(idx)];\r\n                if(isMulti) {\r\n                    ref = ref[0]\r\n                }\r\n\r\n                ref.handleRemove(file, file.raw);\r\n            },\r\n            getReplaceHis(idx) {\r\n                if(this.nodeList[idx].replaceHis.length == 0) {\r\n                    this.$message.info('没有替换历史');\r\n                    return false;\r\n                }\r\n\r\n                let hisHtml = '';\r\n                this.nodeList[idx].replaceHis.map((his, key) => {\r\n                    hisHtml += `<p>#${key} ${his}<p>`;\r\n                });\r\n\r\n                this.$alert(hisHtml, '替换历史', {\r\n                    dangerouslyUseHTMLString: true\r\n                });\r\n            },\r\n\r\n            doReplace(idx, isBatch = false) {\r\n\r\n                if(this.nodeList[idx].fileList.length == 0) {\r\n                    if(!isBatch) {\r\n                        this.$message.info(\"请先上传文件！\");\r\n                    }\r\n\r\n                    return false;\r\n                }\r\n\r\n                let node = this.nodeList[idx];\r\n                let replaceKey = this.createReplaceKey(node.search, node.replace);\r\n                node.replaceHis.push(replaceKey);\r\n\r\n                let promiseList = [];\r\n                node.fileList.map(file => {\r\n                    let p = this.readFile(file, res => {\r\n                        res = res.replace(new RegExp(node.search, 'g'), node.replace);\r\n                        //debugger\r\n                        file.raw = new File([res], file.name, {\r\n                            name: file.name,\r\n                            size: res.length,\r\n                            type: file.type,\r\n                            uid: file.uid,\r\n                            lastModified: file.lastModified,\r\n                        });\r\n\r\n                        file.raw.uid = file.uid;\r\n                        this.$message({\r\n                            message: file.name + ' 替换成功',\r\n                            type: 'success'\r\n                        });\r\n\r\n                        return res;\r\n                    });\r\n\r\n                    promiseList.push(p);\r\n                });\r\n\r\n                Promise.all([...promiseList]).then(res => {\r\n                    console.log('replace res: ', res);\r\n                });\r\n            },\r\n\r\n            fileContentDecode(binaryStr) {\r\n                return iconv.decode(binaryStr, this.detectCharset(binaryStr));\r\n            },\r\n\r\n            detectCharset(binaryStr) {\r\n                let collect = jschardet.detectAll(binaryStr);\r\n                let result = '';\r\n                let confidence = 0;\r\n\r\n                for(let idx in collect) {\r\n                    if(collect[idx].confidence > confidence) {\r\n                        result = collect[idx].encoding;\r\n                        confidence = collect[idx].confidence;\r\n                    }\r\n                }\r\n\r\n                if(['TIS-620', 'windows-1252'].indexOf(result) != -1) {\r\n                    result = 'GBK';\r\n                }\r\n\r\n                console.error(collect, result);\r\n\r\n                return result;\r\n            },\r\n\r\n            downloadFileByContent(content, fileName) {\r\n               let file = new File([content], fileName, {\r\n                   type: 'text/plain',\r\n               });\r\n               console.warn(file)\r\n               this.downloadBlob(URL.createObjectURL(file), fileName);\r\n            },\r\n\r\n            downloadFile(idx) {\r\n                if(!this.nodeList.hasOwnProperty(idx)) {\r\n                    this.$message.info(\"请上传文件！\");\r\n                    return false;\r\n                }\r\n\r\n                if(!this.form.filePath) {\r\n                    this.$message.info(\"程式保存路径未配置，请到程式串联页面配置\");\r\n                    return false;\r\n                }\r\n\r\n                this.nodeList[idx].fileList.map(file => {\r\n                    let name = file.name.substring(0, file.name.lastIndexOf(\".\"));\r\n                    let suffix = file.name.substring(file.name.lastIndexOf(\".\"));\r\n                    if(this.nodeList[idx].replaceHis.length > 0) {\r\n                        //name += \"(\" + this.nodeList[idx].replaceHis.join(\",\") + \")\";\r\n                    }\r\n\r\n                    console.warn(file.name)\r\n                    //this.downloadBlob(url, name + suffix);\r\n                    this.readFile(file, res => {\r\n                        let path = this.form.filePath + \"/\" + name + suffix;\r\n                        this.wmcWrite(path, res);\r\n                        this.$message.success(\"程式保存成功，程式名： \" + path)\r\n                    })\r\n                });\r\n            },\r\n            initNodeList() {\r\n                for (let i = 0; i < this.nodeNum; i++) {\r\n                    this.nodeList.push(this.initNode());\r\n                }\r\n            },\r\n            initNode() {\r\n                return {\r\n                    search: '',\r\n                    replace: '',\r\n                    fileNum: 0,\r\n                    fileList: [\r\n                        //{name: \"test.json\", uid: 55555, id:1}\r\n                    ],\r\n                    isReplace: false,\r\n                    replaceHis: [],\r\n                };\r\n            },\r\n            handleClick(tab, event) {\r\n                console.log(tab, event);\r\n            },\r\n\r\n            handleRemove(idx) {\r\n                return (file, fileList) => {\r\n                    console.log(idx, file, fileList)\r\n                    /*for(var key in fileList) {\r\n                        if(file.name == fileList[key].name) {\r\n                            return false;\r\n                        }\r\n                    }*/\r\n\r\n                    if(idx == this.specialKey) {\r\n                        this.specialFileList = fileList;\r\n                    } else if(idx == this.specialBoxKey) {\r\n                        this.specialBoxFileList = fileList;\r\n                    } else {\r\n                        this.nodeList[idx].fileNum--;\r\n                        this.nodeList[idx].fileList = fileList;\r\n\r\n                        if(fileList.length == 0) {\r\n                            this.nodeList[idx].replaceHis = [];\r\n                        }\r\n                    }\r\n\r\n                    let nameIdx = this.tmpFileNames[idx].indexOf(file.name);\r\n                    delete this.tmpFileNames[idx][nameIdx];\r\n                };\r\n            },\r\n\r\n            handlePreview(file) {\r\n                console.log(file);\r\n            },\r\n            handleProgress(event, file, fileList) {\r\n                console.log(event, file);\r\n            },\r\n\r\n            myHandleChange(idx) {\r\n                return (file, fileList) => {\r\n                    if (!this.tmpFileNames.hasOwnProperty(idx)) {\r\n                        this.tmpFileNames[idx] = [];\r\n                    }\r\n\r\n                    if (this.tmpFileNames[idx].indexOf(file.name) != -1) {\r\n                        this.$message.warning(\"出现重复文件： \" + file.name + \", 取消当前上传！\");\r\n                        console.log(this.createUploadKey(idx))\r\n                        console.log(this.$refs[this.createUploadKey(idx)])\r\n\r\n                        if(idx == this.specialKey || idx == this.specialBoxKey) {\r\n                            this.$refs[this.createUploadKey(idx)].handleRemove(file, file.raw);\r\n                        } else {\r\n                            this.$refs[this.createUploadKey(idx)][0].handleRemove(file, file.raw);\r\n                        }\r\n\r\n                        return false;\r\n                    }\r\n\r\n                    file.id = this.createId();\r\n                    file.headerDeleteLine = 1;\r\n                    file.footerDeleteLine = 1;\r\n\r\n                    //cache file content \r\n                    this.readFile(file, res => { file.content = res; });\r\n\r\n                    //file.\r\n                    if(idx == this.specialKey) {\r\n                        //debugger\r\n                        this.specialFileList = fileList;\r\n                        console.log(this.specialFileList)\r\n                    } else if(idx == this.specialBoxKey) {\r\n                        this.specialBoxFileList = fileList;\r\n                        console.log(fileList)\r\n                    } else {\r\n                        this.nodeList[idx].fileNum++;\r\n                        this.nodeList[idx].fileList = fileList;\r\n                    }\r\n\r\n                    this.tmpFileNames[idx].push(file.name);\r\n                };\r\n            },\r\n\r\n            downloadBlob(blobUrl, fileName, revokeObjectURL) {\r\n                let downloadElement = document.createElement('a');\r\n                downloadElement.href = blobUrl;\r\n                //下载后文件名\r\n                downloadElement.download = fileName;\r\n                console.log(fileName)\r\n                document.body.appendChild(downloadElement);\r\n                //点击下载\r\n                downloadElement.click();\r\n                //下载完成移除元素\r\n                document.body.removeChild(downloadElement);\r\n                if (revokeObjectURL == null || revokeObjectURL) {\r\n                    //释放掉blob对象\r\n                    window.URL.revokeObjectURL(blobUrl)\r\n                }\r\n            },\r\n\r\n            createUploadKey(idx) {\r\n                return 'upload' + idx;\r\n            },\r\n\r\n            createReplaceKey(search, replace) {\r\n                return search + ' = ' + replace;\r\n            },\r\n\r\n            createId() {\r\n                return this.curId++;\r\n            },\r\n\r\n            createDeleteKey(id, mode) {\r\n                return id + '-' + mode;\r\n            },\r\n\r\n            getDatetime() {\r\n                let dateObj = new Date();\r\n                \r\n                let datetime = dateObj.getFullYear() + '-' \r\n                            + this.fixDate(dateObj.getMonth()) + '-' \r\n                            + this.fixDate(dateObj.getDate()) + ' ' \r\n                            + this.fixDate(dateObj.getHours()) + ':' \r\n                            + this.fixDate(dateObj.getMinutes()) + ':' \r\n                            + this.fixDate(dateObj.getSeconds());\r\n\r\n                return datetime;\r\n            },\r\n            fixDate(num)\r\n            {\r\n                if(num.toString().length > 1) {\r\n                    return num;\r\n                }\r\n\r\n                return \"0\" + num;\r\n            }\r\n\r\n        }\r\n    };\r\n</script>\r\n<style>\r\n    #tab-first {\r\n        border: none !important;;\r\n        outline:none !important;\r\n    }\r\n    .wrap {\r\n        border: 1px solid #ebebeb;\r\n        border-radius: 3px;\r\n        transition: .2s;\r\n        margin-top: 20px;\r\n        padding: 20px !important;\r\n    }\r\n\r\n    .wrap div {\r\n        outline:none !important;\r\n        -webkit-tap-highlight-color:rgba(0,0,0,0);\r\n    }\r\n\r\n    .wrap *:focus {\r\n        outline:none !important;\r\n        -webkit-tap-highlight-color:rgba(0,0,0,0);\r\n    }\r\n\r\n    *:focus {\r\n        outline: none;\r\n        -webkit-tap-highlight-color:rgba(0,0,0,0);\r\n    }\r\n\r\n    .content-overflow {\r\n        height: 200px;\r\n        overflow-y: scroll;\r\n        overflow-x: hidden;\r\n    }\r\n\r\n    .content-overflow::-webkit-scrollbar{\r\n        width: 0;\r\n    }\r\n\r\n    .margin-bottom-10 {\r\n        margin-bottom: 10px;\r\n    }\r\n\r\n    .text {\r\n        font-size: 14px;\r\n    }\r\n\r\n    .item {\r\n        margin-bottom: 18px;\r\n    }\r\n\r\n    .clearfix:before,\r\n    .clearfix:after {\r\n        display: table;\r\n        content: \"\";\r\n    }\r\n\r\n    .clearfix:after {\r\n        clear: both\r\n    }\r\n\r\n    .box-card {\r\n    }\r\n\r\n    /** upload icon*/\r\n    .my-avatar-uploader {\r\n        border: 1px dashed #d9d9d9;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n        position: relative;\r\n        overflow: hidden;\r\n        text-align: center;\r\n    }\r\n\r\n    .my-avatar-uploader:hover {\r\n        border-color: #409EFF;\r\n    }\r\n\r\n    .my-avatar-uploader .avatar-uploader-icon {\r\n        font-size: 50px;\r\n        color: #8c939d;\r\n        text-align: center;\r\n        width: 50px;\r\n        height: 50px;\r\n        line-height: 210px;\r\n\r\n    }\r\n\r\n    .my-avatar-uploader .avatar {\r\n        width: 178px;\r\n        height: 178px;\r\n        display: block;\r\n    }\r\n\r\n    .sr-upload-demo {\r\n        position: relative;\r\n        height: 100%;\r\n        width: 100%;\r\n    }\r\n\r\n    .sr-upload-demo .el-upload {\r\n        position: absolute;\r\n        z-index: 99;\r\n        border: 0px !important;\r\n        background: none;\r\n        width: 100%;\r\n    }\r\n\r\n    .sr-upload-demo .el-upload .el-upload-dragger {\r\n\r\n        border: 0px !important;\r\n        background: none;\r\n        width: 100%;\r\n        height: 100%;\r\n    }\r\n\r\n    .sr-upload-demo .el-icon-close {\r\n        position: absolute;\r\n        z-index: 999;\r\n        display: block;\r\n    }\r\n\r\n    .upload-demo {\r\n        position: relative;\r\n    }\r\n\r\n    .upload-demo .el-upload {\r\n        position: absolute;\r\n        z-index: 99;\r\n        border: 0px !important;\r\n        background: none;\r\n        width: 100%;\r\n    }\r\n\r\n    .upload-demo .el-upload .el-upload-dragger {\r\n\r\n        border: 0px !important;\r\n        background: none;\r\n        width: 100%;\r\n        height: 100%;\r\n    }\r\n\r\n    .upload-demo .el-icon-close {\r\n        position: absolute;\r\n        z-index: 999;\r\n        display: block;\r\n    }\r\n\r\n\r\n    #app {\r\n        overflow: scroll;\r\n    }\r\n\r\n    .margin-left-3 {\r\n        margin-left: 3px !important;\r\n    }\r\n\r\n    .margin-left-10 {\r\n        margin-left: 10px;\r\n    }\r\n\r\n    .ml-3 {\r\n        margin-left: 3px !important;\r\n    }\r\n    .mt-10 {\r\n        margin-top: 10px;\r\n    }\r\n\r\n    .mb-3 {\r\n        margin-bottom: 3px;\r\n    }\r\n\r\n    .large-btn {\r\n        width: 100%;\r\n    }\r\n\r\n\r\n    .drag-box{\r\n        display: flex;\r\n        user-select: none;\r\n    }\r\n    .drag-box-item {\r\n        flex: 1;\r\n        background-color: #eff1f5;\r\n        margin-right: 16px;\r\n        border-radius: 6px;\r\n        border: 1px #e1e4e8 solid;\r\n    }\r\n    .item-title{\r\n        padding: 8px 8px 8px 12px;\r\n        font-size: 14px;\r\n        line-height: 1.5;\r\n        color: #24292e;\r\n        font-weight: 600;\r\n    }\r\n    .item-ul{\r\n        padding: 0 8px 8px;\r\n        max-height: 1000px;\r\n        overflow-y: scroll;\r\n    }\r\n    .item-ul::-webkit-scrollbar{\r\n        width: 0;\r\n    }\r\n\r\n    .overflow-text {\r\n        display: block;\r\n        color: #606266;\r\n        overflow: hidden;\r\n        max-width: 250px;\r\n        padding-left: 4px;\r\n        text-overflow: ellipsis;\r\n        transition: color .3s;\r\n        white-space: nowrap;\r\n        line-height: 30px;\r\n    }\r\n\r\n    .drag-list {\r\n        border: 1px #e1e4e8 solid;\r\n        padding: 10px;\r\n        margin: 5px 0 10px;\r\n        list-style: none;\r\n        background-color: #fff;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n        -webkit-transition: border .3s ease-in;\r\n        transition: border .3s ease-in;\r\n    }\r\n    .drag-list:hover {\r\n        border: 1px solid #20a0ff;\r\n    }\r\n    .drag-title {\r\n        font-weight: 400;\r\n        line-height: 25px;\r\n        margin: 10px 0;\r\n        font-size: 22px;\r\n        color: #1f2f3d;\r\n    }\r\n    .ghost-style{\r\n        display: block;\r\n        color: transparent;\r\n        border-style: dashed\r\n    }\r\n\r\n    .el-select .el-input {\r\n        width: 130px;\r\n    }\r\n\r\n    .el-message-box {\r\n        z-index: 99999;\r\n        position: relative;\r\n    }\r\n\r\n    .min-with-80 {\r\n        width: 80px;\r\n    }\r\n\r\n    .el-upload--text {\r\n        border: 0;\r\n    }\r\n\r\n    .third-box {\r\n        margin-top: 10px;\r\n    }\r\n\r\n    .third-box .box-card{\r\n        background: #eff1f5;\r\n    }\r\n\r\n    .third-box .el-card__body{\r\n        padding: 10px;\r\n    }\r\n\r\n    .third-box .content-overflow {\r\n        background: white;\r\n        height: 450px;\r\n        margin-top: 5px;\r\n        border-radius: 5px;\r\n    }\r\n\r\n    .third-box .box-operator {\r\n        margin-top: 15px;\r\n    }\r\n\r\n    .third-box .upload-demo,.el-upload {\r\n        width: 100%;\r\n        height: 100%;\r\n    }\r\n\r\n    .third-box .upload-demo .el-icon-close {\r\n        position: absolute;\r\n        z-index: 999;\r\n        display: block;\r\n    }\r\n\r\n    .third-box .upload-demo .el-upload-list__item-status-label {\r\n        z-index: 998;\r\n        display: none;\r\n    }\r\n\r\n    .third-box .special-input {\r\n        width: auto;\r\n    }\r\n\r\n    .third-box .search {\r\n        width: 130px;\r\n    }\r\n\r\n    .third-box .s-input {\r\n        width: 100%;\r\n    }\r\n\r\n    .third-box .s-radio {\r\n        width: 100%;\r\n        height: 170px;\r\n    }\r\n\r\n    .third-box .s-radio .el-radio__label:before, .third-box .s-radio .el-radio__label:after {\r\n        display: table;\r\n        content: \"\";\r\n    }\r\n\r\n    .third-box .s-radio .el-radio__label:after {\r\n        clear: both;\r\n    }\r\n\r\n\r\n\r\n    .third-box .t-close {\r\n        font-size: 20px;\r\n        margin-top: -10px;\r\n        cursor: pointer;\r\n    }\r\n    .third-box .t-close i{\r\n        display: inline-block;\r\n        width: 100%;\r\n        height: 100%;\r\n    }\r\n\r\n   .third-box .box-card-title {\r\n        display: block;\r\n        position: absolute;\r\n        top: 0px;\r\n        z-index: 999;\r\n        background: white;\r\n    }\r\n\r\n    .third-box .folder-content {\r\n        border-radius: 5px;\r\n        border: 1px solid #8080805e;\r\n        height: 450px;\r\n        overflow: scroll;\r\n        margin-top: 10px;\r\n    }\r\n\r\n    .third-box .folder-select-title {\r\n        font-weight: bold;\r\n    }\r\n\r\n    .wrap-card .el-card__header{\r\n        padding: 10px 10px;\r\n    }\r\n\r\n    .cb-his-card-header {\r\n        font-weight: bold;\r\n    }\r\n\r\n    .my-editor {\r\n  background: #2d2d2d;\r\n  color: #ccc;\r\n\r\n  font-family: Fira code, Fira Mono, Consolas, Menlo, Courier, monospace;\r\n  font-size: 14px;\r\n  line-height: 1.5;\r\n  padding: 5px;\r\n}\r\n\r\n.prism-editor__textarea:focus {\r\n  outline: none;\r\n}\r\n\r\n.height-300 {\r\n  height: 300px;\r\n}\r\n\r\n.prism-editor-wrap {\r\n    width: 500px;\r\n    height: 500px;\r\n}\r\n\r\n.prism-editor-wrapper .prism-editor__line-numbers {\r\n    height: auto !important;\r\n}\r\n\r\n</style>\r\n"]}]}