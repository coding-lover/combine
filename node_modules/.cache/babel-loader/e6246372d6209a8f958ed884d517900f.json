{"remainingRequest":"/data/www/combine/node_modules/thread-loader/dist/cjs.js!/data/www/combine/node_modules/babel-loader/lib/index.js!/data/www/combine/node_modules/cache-loader/dist/cjs.js??ref--0-0!/data/www/combine/node_modules/vue-loader/lib/index.js??vue-loader-options!/data/www/combine/src/components/page/Combine.vue?vue&type=script&lang=js&","dependencies":[{"path":"/data/www/combine/src/components/page/Combine.vue","mtime":1665587308296},{"path":"/data/www/combine/babel.config.js","mtime":1618905572683},{"path":"/data/www/combine/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/data/www/combine/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/data/www/combine/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/data/www/combine/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/data/www/combine/node_modules/vue-loader/lib/index.js","mtime":1655715099000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.array.last-index-of\";\nimport \"core-js/modules/es6.function.name\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.string.iterator\";\nimport \"core-js/modules/es6.regexp.split\";\nimport \"core-js/modules/es6.array.filter\";\nimport _toConsumableArray from \"/data/www/combine/node_modules/@babel/runtime-corejs2/helpers/esm/toConsumableArray.js\";\nimport \"core-js/modules/es6.array.map\";\nimport \"core-js/modules/es6.array.index-of\";\nimport \"core-js/modules/es6.regexp.replace\";\nimport \"core-js/modules/es6.regexp.search\";\nimport ElTableDraggable from 'element-ui-el-table-draggable';\nvar iconv = require('iconv-lite');\nvar jschardet = require(\"jschardet\");\nexport default {\n  data: function data() {\n    var _this = this;\n    return {\n      activeName: 'first',\n      fileList: [],\n      tmpFileNames: [],\n      nodeList: [],\n      nodeNum: 2,\n      replaceHis: [],\n      specialFileList: [],\n      specialKey: 99,\n      form: {\n        fileHeader: '',\n        fileFooter: '',\n        fileName: '',\n        fileSuffix: \".nc\",\n        fileSuffixOptions: [{\n          value: \".nc\",\n          name: \".nc\"\n        }, {\n          value: \".pim\",\n          name: \".pim\"\n        }],\n        ready: true,\n        delivery: true\n      },\n      dragOptions: {\n        animation: 120,\n        scroll: true,\n        group: 'sortlist',\n        ghostClass: 'ghost-style'\n      },\n      curId: 0,\n      combineFileList: [],\n      dragList: [],\n      dragConfig: {\n        optionVal: 0,\n        options: [{\n          value: 0,\n          label: \"文件头删除行数\"\n        }, {\n          value: 1,\n          label: \"文件尾删除行数\"\n        }],\n        setVal: 1\n      },\n      formRules: {\n        fileHeader: [{\n          required: true,\n          message: '请输入文件头',\n          trigger: 'blur'\n        }],\n        fileFooter: [{\n          required: true,\n          message: '请输入文件尾',\n          trigger: 'change'\n        }],\n        fileName: [{\n          required: true,\n          message: '请输入完整文件名',\n          trigger: 'change',\n          validator: function validator(rule, value, callback) {\n            if (!_this.form.fileName) {\n              return callback(new Error('请输入完整文件名'));\n            }\n            if (_this.form.fileSuffix === '') {\n              return callback(new Error('请选择文件后缀'));\n            }\n            callback();\n          }\n        }],\n        fileSuffix: [{\n          required: true,\n          message: '请选择文件后缀',\n          trigger: 'change'\n        }]\n      }\n    };\n  },\n  components: {\n    ElTableDraggable: ElTableDraggable\n  },\n  computed: {\n    replaceFlag: function replaceFlag() {\n      var _this2 = this;\n      return function (idx) {\n        if (!_this2.nodeList.hasOwnProperty(idx)) {\n          return false;\n        }\n        var node = _this2.nodeList[idx];\n        var replaceKey = _this2.createReplaceKey(node.search, node.replace);\n        return node.replaceHis.indexOf(replaceKey) != -1;\n      };\n    },\n    totalNum: function totalNum() {\n      var num = 0;\n      this.nodeList.map(function (node) {\n        num += node.fileList.length;\n      });\n      return num;\n    },\n    specialNum: function specialNum() {\n      return this.specialFileList.length;\n    },\n    getFileList: {\n      get: function get() {\n        var fileList = [];\n        if (this.form.delivery) {\n          this.nodeList.map(function (node, nodeIdx) {\n            node.fileList.map(function (file, fileIdx) {\n              file.nodeIdx = nodeIdx;\n              file.fileIdx = fileIdx;\n              fileList.push(file);\n            });\n          });\n        } else {\n          //debugger\n          fileList.push.apply(fileList, _toConsumableArray(this.specialFileList));\n        }\n        return fileList;\n      },\n      set: function set(value) {\n        console.warn(value);\n      }\n    },\n    getFileBadge: function getFileBadge() {\n      var _this3 = this;\n      return function (rawName) {\n        return rawName + (_this3.totalNum > 0 ? '<el-badge value=\"' + _this3.totalNum + '\" class=\"large-btn\"  />' : '');\n      };\n    }\n  },\n  watch: {\n    //nodeList: {\n    // immediate: true,\n    // //deep: true,\n    // handler(nodeList) {\n    //\n    // }\n    //},\n  },\n  mounted: function mounted() {\n    this.initNodeList();\n    console.log(iconv.encodingExists('windows-1252'));\n  },\n  methods: {\n    combineFile: function combineFile() {\n      var _this4 = this;\n      this.$refs['form'].validate(function (valid) {\n        if (!valid) {\n          return false;\n        }\n        var rawList = [];\n        var rawIds = [];\n        _this4.nodeList.map(function (node) {\n          node.fileList.map(function (file) {\n            rawIds.push(file.id);\n            rawList.push(file);\n          });\n        });\n        rawList.push.apply(rawList, _toConsumableArray(_this4.specialFileList));\n        if (_this4.dragList.length != rawList.length) {\n          _this4.dragList = rawList;\n        }\n        if (_this4.dragList.length == 0) {\n          _this4.$message.info('请上传要合并的文件');\n          return false;\n        }\n        var promiseList = [];\n        _this4.dragList.map(function (file) {\n          //debugger\n          if (_this4.form.delivery && rawIds.indexOf(file.id) == -1) {\n            return false;\n          }\n          if (!_this4.form.delivery && rawIds.indexOf(file.id) != -1) {\n            return false;\n          }\n          var p = _this4.readFile(file, function (res) {\n            res = res.split(\"\\n\").filter(function (res) {\n              return res;\n            });\n            res.splice(0, file.headerDeleteLine);\n            res.splice(res.length - file.footerDeleteLine, file.footerDeleteLine);\n            return res.join(\"\\n\");\n          });\n          promiseList.push(p);\n        });\n        if (promiseList.length == 0) {\n          _this4.$message.info('请上传文件');\n          return false;\n        }\n        _this4.form.ready = false;\n        Promise.all([].concat(promiseList)).then(function (res) {\n          console.log(res);\n          res.unshift(_this4.form.fileHeader);\n          res.push(_this4.form.fileFooter);\n          res = res.filter(function (res) {\n            return res;\n          });\n          res = res.join(\"\\n\");\n          console.log(res);\n          _this4.form.ready = true;\n          _this4.downloadFileByContent(res, _this4.form.fileName + _this4.form.fileSuffix);\n          _this4.$message.success(\"合并成功，文件：\" + _this4.form.fileName + _this4.form.fileSuffix);\n        });\n        console.log('content');\n      });\n    },\n    test: function test(flag) {\n      return new Promise(function (resolve, reject) {\n        var time = Math.ceil(Math.random() * 10000);\n        console.warn('执行 ' + flag);\n        setTimeout(function () {\n          resolve(time + '-' + flag);\n        }, time);\n      });\n    },\n    readFile: function readFile(file, callback) {\n      var _this5 = this;\n      return new Promise(function (resolve, reject) {\n        var fileReader = new FileReader();\n        fileReader.onloadend = function (event) {\n          console.warn(event);\n          console.warn(_this5.detectCharset(event.target.result));\n          resolve(callback(_this5.fileContentDecode(event.target.result)));\n        };\n        fileReader.readAsBinaryString(file.raw);\n      });\n    },\n    fileConfigAdd: function fileConfigAdd() {\n      this.dispatchFileConfig(true);\n    },\n    fileConfigReduce: function fileConfigReduce() {\n      this.dispatchFileConfig(false);\n    },\n    dispatchFileConfig: function dispatchFileConfig() {\n      var _this6 = this;\n      var isAdd = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;\n      if (this.form.delivery) {\n        this.nodeList.map(function (node) {\n          node.fileList.map(function (file) {\n            _this6.doUpdateDeletedLine(file, isAdd);\n          });\n        });\n      } else {\n        this.specialFileList.map(function (file) {\n          _this6.doUpdateDeletedLine(file, isAdd);\n        });\n      }\n    },\n    doUpdateDeletedLine: function doUpdateDeletedLine(file) {\n      var isAdd = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n      var key = this.dragConfig.optionVal == 0 ? 'headerDeleteLine' : 'footerDeleteLine';\n      file[key] = file[key] == undefined ? 0 : file[key];\n      if (isAdd) {\n        file[key] += this.dragConfig.setVal;\n      } else {\n        file[key] -= this.dragConfig.setVal;\n      }\n      file[key] = file[key] < 0 ? 0 : file[key];\n      this.updateDeletedLine(file.id, key, file[key]);\n    },\n    updateDeletedLine: function updateDeletedLine(id, mode, value) {\n      var key = this.createDeleteKey(id, mode);\n      this.$refs[key].setCurrentValue(value);\n    },\n    dragChange: function dragChange(log) {\n      this.dragList = log.list;\n      console.log(log);\n    },\n    formReset: function formReset() {\n      this.$refs.form.resetFields();\n      for (var key in this.form) {\n        if (key == 'fileSuffixOptions') {\n          continue;\n        }\n        if (this.form.hasOwnProperty(key)) {\n          this.form[key] = key == 'ready' || key == \"delivery\" ? true : '';\n        }\n      }\n    },\n    removeHandle: function removeHandle(event) {\n      console.log(event);\n      this.$message.success(\"\\u4ECE \".concat(event.from.id, \" \\u79FB\\u52A8\\u5230 \").concat(event.to.id, \" \"));\n    },\n    addNode: function addNode() {\n      this.nodeList.push(this.initNode());\n    },\n    batchReplace: function batchReplace() {\n      var _this7 = this;\n      this.nodeList.map(function (node, idx) {\n        _this7.doReplace(idx);\n      });\n    },\n    batchDownload: function batchDownload() {\n      var _this8 = this;\n      this.nodeList.map(function (node, idx) {\n        _this8.downloadFile(idx);\n      });\n    },\n    getReplaceHis: function getReplaceHis(idx) {\n      if (this.nodeList[idx].replaceHis.length == 0) {\n        this.$message.info('没有替换历史');\n        return false;\n      }\n      var hisHtml = '';\n      this.nodeList[idx].replaceHis.map(function (his, key) {\n        hisHtml += \"<p>#\".concat(key, \" \").concat(his, \"<p>\");\n      });\n      this.$alert(hisHtml, '替换历史', {\n        dangerouslyUseHTMLString: true\n      });\n    },\n    doReplace: function doReplace(idx) {\n      var _this9 = this;\n      if (this.nodeList[idx].fileList.length == 0) {\n        this.$message.info(\"请先上传文件！\");\n        return false;\n      }\n      var node = this.nodeList[idx];\n      var replaceKey = this.createReplaceKey(node.search, node.replace);\n      node.replaceHis.push(replaceKey);\n      var promiseList = [];\n      node.fileList.map(function (file) {\n        var p = _this9.readFile(file, function (res) {\n          res = res.replaceAll(node.search, node.replace);\n          file.raw = new File([res], file.name, {\n            name: file.name,\n            size: res.length,\n            type: file.type,\n            lastModified: file.lastModified\n          });\n          _this9.$message({\n            message: file.name + ' 替换成功',\n            type: 'success'\n          });\n          return res;\n        });\n        promiseList.push(p);\n      });\n      Promise.all([].concat(promiseList)).then(function (res) {\n        console.log('replace res: ', res);\n      });\n    },\n    fileContentDecode: function fileContentDecode(binaryStr) {\n      return iconv.decode(binaryStr, this.detectCharset(binaryStr));\n    },\n    detectCharset: function detectCharset(binaryStr) {\n      var collect = jschardet.detectAll(binaryStr);\n      var result = '';\n      var confidence = 0;\n      for (var idx in collect) {\n        if (collect[idx].confidence > confidence) {\n          result = collect[idx].encoding;\n          confidence = collect[idx].confidence;\n        }\n      }\n      if (['TIS-620', 'windows-1252'].indexOf(result) != -1) {\n        result = 'GBK';\n      }\n      console.error(collect, result);\n      return result;\n    },\n    downloadFileByContent: function downloadFileByContent(content, fileName) {\n      var file = new File([content], fileName, {\n        type: 'text/plain'\n      });\n      console.warn(file);\n      this.downloadBlob(URL.createObjectURL(file), fileName);\n    },\n    downloadFile: function downloadFile(idx) {\n      var _this10 = this;\n      if (!this.nodeList.hasOwnProperty(idx)) {\n        this.$message.info(\"请上传文件！\");\n        return false;\n      }\n      this.nodeList[idx].fileList.map(function (file) {\n        var url = URL.createObjectURL(file.raw);\n        var name = file.name.substring(0, file.name.lastIndexOf(\".\"));\n        var suffix = file.name.substring(file.name.lastIndexOf(\".\"));\n        if (_this10.nodeList[idx].replaceHis.length > 0) {\n          name += \"(\" + _this10.nodeList[idx].replaceHis.join(\",\") + \")\";\n        }\n        console.warn(file.name);\n        _this10.downloadBlob(url, name + suffix);\n      });\n    },\n    initNodeList: function initNodeList() {\n      for (var i = 0; i < this.nodeNum; i++) {\n        this.nodeList.push(this.initNode());\n      }\n    },\n    initNode: function initNode() {\n      return {\n        search: '',\n        replace: '',\n        fileNum: 0,\n        fileList: [\n          //{name: \"test.json\", uid: 55555, id:1}\n        ],\n        isReplace: false,\n        replaceHis: []\n      };\n    },\n    handleClick: function handleClick(tab, event) {\n      console.log(tab, event);\n    },\n    handleRemove: function handleRemove(idx) {\n      var _this11 = this;\n      return function (file, fileList) {\n        console.log(file, fileList);\n        for (var key in fileList) {\n          if (file.name == fileList[key].name) {\n            return false;\n          }\n        }\n        if (idx == _this11.specialKey) {\n          _this11.specialFileList = fileList;\n        } else {\n          _this11.nodeList[idx].fileNum--;\n          _this11.nodeList[idx].fileList = fileList;\n          if (fileList.length == 0) {\n            _this11.nodeList[idx].replaceHis = [];\n          }\n        }\n        var nameIdx = _this11.tmpFileNames[idx].indexOf(file.name);\n        delete _this11.tmpFileNames[idx][nameIdx];\n      };\n    },\n    handlePreview: function handlePreview(file) {\n      console.log(file);\n    },\n    handleProgress: function handleProgress(event, file, fileList) {\n      console.log(event, file);\n    },\n    myHandleChange: function myHandleChange(idx) {\n      var _this12 = this;\n      return function (file, fileList) {\n        if (!_this12.tmpFileNames.hasOwnProperty(idx)) {\n          _this12.tmpFileNames[idx] = [];\n        }\n        if (_this12.tmpFileNames[idx].indexOf(file.name) != -1) {\n          _this12.$message.warning(\"出现重复文件： \" + file.name + \", 取消当前上传！\");\n          console.log(_this12.createUploadKey(idx));\n          console.log(_this12.$refs[_this12.createUploadKey(idx)]);\n          if (idx == _this12.specialKey) {\n            _this12.$refs[_this12.createUploadKey(idx)].handleRemove(file, file.raw);\n          } else {\n            _this12.$refs[_this12.createUploadKey(idx)][0].handleRemove(file, file.raw);\n          }\n          return false;\n        }\n        file.id = _this12.createId();\n        file.headerDeleteLine = 1;\n        file.footerDeleteLine = 1;\n\n        //file.\n        if (idx == _this12.specialKey) {\n          //debugger\n          _this12.specialFileList = fileList;\n          console.log(_this12.specialFileList);\n        } else {\n          _this12.nodeList[idx].fileNum++;\n          _this12.nodeList[idx].fileList = fileList;\n        }\n        _this12.tmpFileNames[idx].push(file.name);\n      };\n    },\n    downloadBlob: function downloadBlob(blobUrl, fileName, revokeObjectURL) {\n      var downloadElement = document.createElement('a');\n      downloadElement.href = blobUrl;\n      //下载后文件名\n      downloadElement.download = fileName;\n      console.log(fileName);\n      document.body.appendChild(downloadElement);\n      //点击下载\n      downloadElement.click();\n      //下载完成移除元素\n      document.body.removeChild(downloadElement);\n      if (revokeObjectURL == null || revokeObjectURL) {\n        //释放掉blob对象\n        window.URL.revokeObjectURL(blobUrl);\n      }\n    },\n    createUploadKey: function createUploadKey(idx) {\n      return 'upload' + idx;\n    },\n    createReplaceKey: function createReplaceKey(search, replace) {\n      return search + ' = ' + replace;\n    },\n    createId: function createId() {\n      return this.curId++;\n    },\n    createDeleteKey: function createDeleteKey(id, mode) {\n      return id + '-' + mode;\n    }\n  }\n};",{"version":3,"mappings":";;;;;;;;;;;AA8LA;AACA;AACA;AAGA;EACAA;IAAA;IACA;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;QACAC;QACAC;QACAC;QACAC;QACAC,oBACA;UAAAC;UAAAC;QAAA,GACA;UAAAD;UAAAC;QAAA,EACA;QACAC;QACAC;MACA;MACAC;QACAC;QACAC;QACAC;QACAC;MACA;MACAC;MACAC,mBACA;MAEAC;MACAC;QACAC;QACAC,UACA;UAAAd;UAAAe;QAAA,GACA;UAAAf;UAAAe;QAAA,EACA;QAEAC;MACA;MAEAC;QACAtB,aACA;UAAAuB;UAAAC;UAAAC;QAAA,EACA;QACAxB,aACA;UAAAsB;UAAAC;UAAAC;QAAA,EACA;QACAvB,WACA;UAAAqB;UAAAC;UAAAC;UAAAC;YACA;cACA;YACA;YAEA;cACA;YACA;YAEAC;UACA;QAAA,EACA;QACAxB,aACA;UAAAoB;UAAAC;UAAAC;QAAA;MAEA;IACA;EACA;EACAG;IACAC;EACA;EACAC;IACAC;MAAA;MACA;QACA;UACA;QACA;QAEA;QACA;QACA;MACA;IACA;IACAC;MACA;MACA;QACAC;MACA;MAEA;IACA;IACAC;MACA;IACA;IACAC;MACAC;QACA;QAEA;UACA;YACAC;cACAC;cACAA;cACA9C;YACA;UACA;QACA;UACA;UACAA;QACA;QAEA;MACA;MACA+C;QACAC;MACA;IACA;IACAC;MAAA;MACA;QACA;MACA;IACA;EACA;EACAC;IACA;IACA;IACA;IACA;IACA;IACA;IACA;EACA;EACAC;IACA;IAEAH;EACA;EAEAI;IACAC;MAAA;MACA;QACA;UACA;QACA;QAEA;QACA;QACA;UACAR;YACAS;YACAC;UACA;QACA;QAEAA;QAEA;UACA;QACA;QAEA;UACA;UACA;QACA;QAEA;QACA;UACA;UACA;YACA;UACA;UAEA;YACA;UACA;UAEA;YACAC;cAAA;YAAA;YACAA;YACAA;YACA;UACA;UAEAC;QACA;QAEA;UACA;UACA;QACA;QAEA;QACAC;UACAV;UACAQ;UACAA;UACAA;YAAA;UAAA;UACAA;UAEAR;UACA;UACA;UACA;QACA;QAEAA;MACA;IACA;IAEAW;MACA;QACA;QACAX;QACAY;UACAC;QACA;MACA;IACA;IAEAC;MAAA;MACA;QACA;QACAC;UACAf;UACAA;UACAa;QACA;QAEAE;MACA;IACA;IACAC;MACA;IACA;IAEAC;MACA;IACA;IAEAC;MAAA;MAAA;MACA;QACA;UACArB;YACA;UACA;QACA;MACA;QACA;UACA;QACA;MACA;IACA;IAEAsB;MAAA;MACA;MACArB;MACA;QACAA;MACA;QACAA;MACA;MAEAA;MACA;IACA;IAEAsB;MACA;MACA;IACA;IAEAC;MACA;MACArB;IAEA;IACAsB;MACA;MACA;QACA;UACA;QACA;QAEA;UACA;QACA;MACA;IACA;IACAC;MACAvB;MACA;IACA;IACAwB;MACA;IACA;IAEAC;MAAA;MACA;QACA;MACA;IACA;IAEAC;MAAA;MACA;QACA;MACA;IACA;IAEAC;MACA;QACA;QACA;MACA;MAEA;MACA;QACAC;MACA;MAEA;QACAC;MACA;IACA;IAEAC;MAAA;MAEA;QACA;QACA;MACA;MAEA;MACA;MACAjC;MAEA;MACAA;QACA;UACAW;UACAV;YACAhC;YACAiE;YACAC;YACAC;UACA;UAEA;YACAjD;YACAgD;UACA;UAEA;QACA;QAEAvB;MACA;MAEAC;QACAV;MACA;IACA;IAEAkC;MACA;IACA;IAEAC;MACA;MACA;MACA;MAEA;QACA;UACAC;UACAC;QACA;MACA;MAEA;QACAD;MACA;MAEApC;MAEA;IACA;IAEAsC;MACA;QACAN;MACA;MACAhC;MACA;IACA;IAEAuC;MAAA;MACA;QACA;QACA;MACA;MAEA;QACA;QACA;QACA;QACA;UACAzE;QACA;QAEAkC;QACA;MACA;IACA;IACAwC;MACA;QACA;MACA;IACA;IACAC;MACA;QACAC;QACAC;QACAC;QACA5F;UACA;QAAA,CACA;QACA6F;QACAzF;MACA;IACA;IACA0F;MACA9C;IACA;IAEA+C;MAAA;MACA;QACA/C;QACA;UACA;YACA;UACA;QACA;QAEA;UACA;QACA;UACA;UACA;UAEA;YACA;UACA;QACA;QAEA;QACA;MACA;IACA;IAEAgD;MACAhD;IACA;IACAiD;MACAjD;IACA;IAEAkD;MAAA;MACA;QACA;UACA;QACA;QAEA;UACA;UACAlD;UACAA;UAEA;YACA;UACA;YACA;UACA;UAEA;QACA;QAEAF;QACAA;QACAA;;QAEA;QACA;UACA;UACA;UACAE;QACA;UACA;UACA;QACA;QAEA;MACA;IACA;IAEAmD;MACA;MACAC;MACA;MACAA;MACApD;MACAqD;MACA;MACAD;MACA;MACAC;MACA;QACA;QACAC;MACA;IACA;IAEAC;MACA;IACA;IAEAC;MACA;IACA;IAEAC;MACA;IACA;IAEAC;MACA;IACA;EAEA;AACA","names":["data","activeName","fileList","tmpFileNames","nodeList","nodeNum","replaceHis","specialFileList","specialKey","form","fileHeader","fileFooter","fileName","fileSuffix","fileSuffixOptions","value","name","ready","delivery","dragOptions","animation","scroll","group","ghostClass","curId","combineFileList","dragList","dragConfig","optionVal","options","label","setVal","formRules","required","message","trigger","validator","callback","components","ElTableDraggable","computed","replaceFlag","totalNum","num","specialNum","getFileList","get","node","file","set","console","getFileBadge","watch","mounted","methods","combineFile","rawIds","rawList","res","promiseList","Promise","test","setTimeout","resolve","readFile","fileReader","fileConfigAdd","fileConfigReduce","dispatchFileConfig","doUpdateDeletedLine","updateDeletedLine","dragChange","formReset","removeHandle","addNode","batchReplace","batchDownload","getReplaceHis","hisHtml","dangerouslyUseHTMLString","doReplace","size","type","lastModified","fileContentDecode","detectCharset","result","confidence","downloadFileByContent","downloadFile","initNodeList","initNode","search","replace","fileNum","isReplace","handleClick","handleRemove","handlePreview","handleProgress","myHandleChange","downloadBlob","downloadElement","document","window","createUploadKey","createReplaceKey","createId","createDeleteKey"],"sourceRoot":"src/components/page","sources":["Combine.vue"],"sourcesContent":["<template>\r\n    <el-row :gutter=\"10\">\r\n        <el-col :span=\"18\" :offset=\"3\" class=\"wrap\">\r\n            <el-tabs v-model=\"activeName\" @tab-click=\"handleClick\">\r\n\r\n                <el-tab-pane  name=\"first\" class=\"wrap-padding\">\r\n                    <span slot=\"label\">文件替换<el-badge :value=\"totalNum\" class=\"large-btn\" :hidden=\"totalNum > 0 ? false : true\" ></el-badge></span>\r\n\r\n                    <el-col :span=\"12\" class=\"margin-bottom-10\" v-for=\"(item, idx) in nodeList\">\r\n                        <el-card class=\"box-card\">\r\n                            <div slot=\"header\" class=\"clearfix\">\r\n                                <el-col :span=\"6\">\r\n                                    <el-input v-model=\"item.search\" prefix-icon=\"el-icon-search\" placeholder=\"要替换字符\"></el-input>\r\n                                </el-col>\r\n                                <el-col :span=\"6\">\r\n                                    <el-input v-model=\"item.replace\" prefix-icon=\"el-icon-edit\" placeholder=\"替换后字符\"></el-input>\r\n                                </el-col>\r\n                                <el-badge :value=\"item.fileNum\" class=\"\" :hidden=\"item.fileNum > 0 ? false : true\">\r\n                                    <el-button v-show=\"!replaceFlag(idx)\" size=\"small\" class=\"ml-3\" type=\"primary\"\r\n                                               @click=\"doReplace(idx)\">替换\r\n                                    </el-button>\r\n                                    <el-button v-show=\"replaceFlag(idx)\" class=\"ml-3\" size=\"small\" type=\"success\">已替换</el-button>\r\n                                    <el-button size=\"small\" type=\"success\" class=\"ml-3\" @click=\"getReplaceHis(idx)\">替换历史</el-button>\r\n                                </el-badge>\r\n                                <el-button size=\"small\" type=\"primary\" class=\"margin-left-3\" @click=\"downloadFile(idx)\">下载</el-button>\r\n\r\n                            </div>\r\n                            <div class=\"content-overflow\">\r\n                                <el-upload\r\n                                        class=\"upload-demo\"\r\n                                        drag\r\n                                        :ref=\"createUploadKey(idx)\"\r\n                                        action=\"\"\r\n                                        :on-preview=\"handlePreview\"\r\n                                        :on-remove=\"handleRemove(idx)\"\r\n                                        :on-progress=\"handleProgress\"\r\n                                        :on-change=\"myHandleChange(idx)\"\r\n                                        :file-list=\"fileList\"\r\n                                        :auto-upload=\"false\"\r\n                                        multiple>\r\n                                    <i class=\"el-icon-upload\" v-show=\"item.fileNum == 0\"></i>\r\n                                    <div class=\"el-upload__text\" v-show=\"item.fileNum == 0\">将文件拖到此处，或<em>点击上传</em></div>\r\n                                </el-upload>\r\n                            </div>\r\n\r\n                        </el-card>\r\n                    </el-col>\r\n\r\n                    <el-col :span=\"12\" class=\"margin-bottom-10\">\r\n                        <div class=\"my-avatar-uploader content-overflow\" @click=\"addNode\">\r\n                            <i class=\"el-icon-plus avatar-uploader-icon\"></i>\r\n                        </div>\r\n\r\n                        <el-row class=\"mt-10\">\r\n                            <el-badge :value=\"totalNum\" class=\"large-btn\" :hidden=\"totalNum > 0 ? false : true\" >\r\n                                <el-button type=\"danger\" size=\"medium\" class=\"large-btn\" @click=\"batchReplace\">批量替换</el-button>\r\n                            </el-badge>\r\n                        </el-row>\r\n\r\n                        <el-row class=\"mt-10\">\r\n                            <el-button type=\"primary\" size=\"medium\" class=\"large-btn\" @click=\"batchDownload\">批量下载</el-button>\r\n                        </el-row>\r\n\r\n                    </el-col>\r\n\r\n\r\n                </el-tab-pane>\r\n\r\n\r\n                <el-tab-pane label=\"文件合并\" name=\"second\">\r\n                    <el-col :span=\"10\">\r\n                        <el-form ref=\"form\" :rules=\"formRules\" :model=\"form\" label-width=\"90px\">\r\n                            <el-form-item label=\"使用替换\">\r\n                                <el-switch v-model=\"form.delivery\">\r\n                                </el-switch>\r\n                                <span style=\"color: #F56C6C;margin-left: 5px;display: inline-block;\">使用已经替换的文件或者重新上传文件</span>\r\n                            </el-form-item>\r\n                            <el-form-item label=\"上传\" v-show=\"!form.delivery\">\r\n                                <span slot=\"label\">上传<el-badge :value=\"specialNum\" :hidden=\"specialNum > 0 ? false : true\" ></el-badge></span>\r\n                                <el-upload\r\n                                        class=\"\"\r\n                                        drag\r\n                                        action=\"\"\r\n                                        :ref=\"createUploadKey(specialKey)\"\r\n                                        :on-change=\"myHandleChange(specialKey)\"\r\n                                        :on-remove=\"handleRemove(specialKey)\"\r\n                                        :auto-upload=\"false\"\r\n                                        multiple>\r\n                                    <i class=\"el-icon-upload\"></i>\r\n                                    <div class=\"el-upload__text\">\r\n\r\n                                        <p>将文件拖到此处，或<em>点击上传</em></p>\r\n                                    </div>\r\n                                </el-upload>\r\n                            </el-form-item>\r\n\r\n                            <el-form-item label=\"文件头\" prop=\"fileHeader\">\r\n                                <el-input type=\"textarea\" v-model=\"form.fileHeader\"></el-input>\r\n                            </el-form-item>\r\n\r\n\r\n                            <el-form-item label=\"文件尾\" prop=\"fileFooter\">\r\n                                <el-input type=\"textarea\" v-model=\"form.fileFooter\"></el-input>\r\n                            </el-form-item>\r\n\r\n                            <el-form-item label=\"文件名\" prop=\"fileName\">\r\n                                <el-input placeholder=\"请输入内容\" v-model=\"form.fileName\" class=\"input-with-select\">\r\n                                    <el-select v-model=\"form.fileSuffix\" slot=\"append\" placeholder=\"请选择\" prop=\"fileSuffix\">\r\n                                        <el-option\r\n                                                v-for=\"item in form.fileSuffixOptions\"\r\n                                                :key=\"item.value\"\r\n                                                :label=\"item.name\"\r\n                                                :value=\"item.value\">\r\n                                        </el-option>\r\n                                    </el-select>\r\n                                </el-input>\r\n\r\n                            </el-form-item>\r\n\r\n                            <el-form-item>\r\n                                <el-button v-show=\"form.ready\" type=\"primary\" @click=\"combineFile\">立即合并</el-button>\r\n                                <el-button v-show=\"!form.ready\" type=\"primary\" :loading=\"true\">合并中</el-button>\r\n                                <el-button @click=\"formReset()\">取消</el-button>\r\n                            </el-form-item>\r\n                        </el-form>\r\n                    </el-col>\r\n                    <el-col :span=\"14\">\r\n\r\n                        <div class=\"drag-box\">\r\n                            <div class=\"drag-box-item\">\r\n                                <el-empty v-show=\"getFileList.length == 0\" description=\"未上传文件\"></el-empty>\r\n                                <el-table-draggable handle=\".allowDrag\" @drop=\"dragChange\">\r\n                                    <el-table\r\n                                            ref=\"dragTable\"\r\n                                            :data=\"getFileList\"\r\n                                            style=\"width: 100%\" v-show=\"getFileList.length > 0\">\r\n                                        <el-table-column\r\n                                                prop=\"id\"\r\n                                                label=\"拖拽\"\r\n                                                width=\"50\">\r\n                                            <template slot-scope=\"{row}\">\r\n                                                <i class=\"el-icon-rank allowDrag\" style=\"cursor:pointer\" /> {{row.id}}\r\n                                            </template>\r\n                                        </el-table-column>\r\n                                        <el-table-column\r\n                                                prop=\"name\"\r\n                                                label=\"文件名\"\r\n                                                width=\"230\" >\r\n                                            <template slot-scope=\"scope\">\r\n                                                <span class=\"overflow-text\">{{scope.row.name}}</span>\r\n                                            </template>\r\n                                        </el-table-column>\r\n                                        <el-table-column\r\n                                                prop=\"option\"\r\n                                                label=\"操作\">\r\n                                            <template slot=\"header\" slot-scope=\"scope\">\r\n                                                <el-select class=\"\" v-model=\"dragConfig.optionVal\" placeholder=\"请选择\" size=\"mini\">\r\n                                                    <el-option\r\n                                                            v-for=\"item in dragConfig.options\"\r\n                                                            :key=\"item.value\"\r\n                                                            :label=\"item.label\"\r\n                                                            :value=\"item.value\">\r\n                                                    </el-option>\r\n                                                </el-select>\r\n\r\n                                                <el-input-number class=\" ml-3\" size=\"mini\" v-model=\"dragConfig.setVal\" controls-position=\"right\"  :min=\"0\" :max=\"10\" placeholder=\"值\"></el-input-number>\r\n\r\n                                                <el-button type=\"primary\" size=\"mini\" class=\"ml-3\" @click=\"fileConfigAdd\">加</el-button>\r\n                                                <el-button type=\"primary\" size=\"mini\" @click=\"fileConfigReduce\">减</el-button>\r\n                                            </template>\r\n                                            <template slot-scope=\"scope\">\r\n                                                <el-input-number :controls=\"false\" :ref=\"createDeleteKey(scope.row.id, 'headerDeleteLine')\" size=\"mini\" v-model=\"scope.row.headerDeleteLine\" controls-position=\"right\"  :min=\"0\"  placeholder=\"文件头删除行数\"></el-input-number>\r\n                                                <el-input-number :controls=\"false\" :ref=\"createDeleteKey(scope.row.id, 'footerDeleteLine')\" class=\"ml-3\" size=\"mini\" v-model=\"scope.row.footerDeleteLine\" controls-position=\"right\" :min=\"0\" placeholder=\"文件尾删除行数\"></el-input-number>\r\n                                            </template>\r\n\r\n                                        </el-table-column>\r\n\r\n                                    </el-table>\r\n                                </el-table-draggable>\r\n                            </div>\r\n                        </div>\r\n\r\n                    </el-col>\r\n\r\n                </el-tab-pane>\r\n            </el-tabs>\r\n        </el-col>\r\n    </el-row>\r\n</template>\r\n<script>\r\n    import ElTableDraggable from 'element-ui-el-table-draggable';\r\n    const iconv = require('iconv-lite');\r\n    const jschardet = require(\"jschardet\")\r\n\r\n\r\n    export default {\r\n        data() {\r\n            return {\r\n                activeName: 'first',\r\n                fileList: [],\r\n                tmpFileNames: [],\r\n                nodeList: [],\r\n                nodeNum: 2,\r\n                replaceHis: [],\r\n                specialFileList: [],\r\n                specialKey: 99,\r\n                form: {\r\n                    fileHeader: '',\r\n                    fileFooter: '',\r\n                    fileName: '',\r\n                    fileSuffix: \".nc\",\r\n                    fileSuffixOptions: [\r\n                        {value: \".nc\", name: \".nc\"},\r\n                        {value: \".pim\", name: \".pim\"},\r\n                    ],\r\n                    ready: true,\r\n                    delivery: true,\r\n                },\r\n                dragOptions:{\r\n                    animation: 120,\r\n                    scroll: true,\r\n                    group: 'sortlist',\r\n                    ghostClass: 'ghost-style'\r\n                },\r\n                curId: 0,\r\n                combineFileList : [\r\n                ],\r\n\r\n                dragList: [],\r\n                dragConfig: {\r\n                    optionVal: 0,\r\n                    options: [\r\n                        {value: 0, label: \"文件头删除行数\"},\r\n                        {value: 1, label: \"文件尾删除行数\"}\r\n                    ],\r\n\r\n                    setVal: 1,\r\n                },\r\n\r\n                formRules: {\r\n                    fileHeader: [\r\n                        { required: true, message: '请输入文件头', trigger: 'blur' },\r\n                    ],\r\n                    fileFooter: [\r\n                        { required: true, message: '请输入文件尾', trigger: 'change' }\r\n                    ],\r\n                    fileName: [\r\n                        { required: true, message: '请输入完整文件名', trigger: 'change', validator: (rule, value, callback) => {\r\n                            if(!this.form.fileName) {\r\n                                return callback(new Error('请输入完整文件名'));\r\n                            }\r\n\r\n                            if(this.form.fileSuffix === '') {\r\n                                return callback(new Error('请选择文件后缀'));\r\n                            }\r\n\r\n                            callback();\r\n                        }}\r\n                    ],\r\n                    fileSuffix: [\r\n                        { required: true, message: '请选择文件后缀', trigger: 'change' }\r\n                    ],\r\n                }\r\n            };\r\n        },\r\n        components:{\r\n            ElTableDraggable\r\n        },\r\n        computed: {\r\n            replaceFlag: function () {\r\n                return (idx) => {\r\n                    if (!this.nodeList.hasOwnProperty(idx)) {\r\n                        return false;\r\n                    }\r\n\r\n                    let node = this.nodeList[idx];\r\n                    let replaceKey = this.createReplaceKey(node.search, node.replace);\r\n                    return node.replaceHis.indexOf(replaceKey) != -1;\r\n                };\r\n            },\r\n            totalNum: function() {\r\n                let num = 0;\r\n                this.nodeList.map(node => {\r\n                    num += node.fileList.length;\r\n                });\r\n\r\n                return num;\r\n            },\r\n            specialNum: function() {\r\n                return this.specialFileList.length;\r\n            },\r\n            getFileList: {\r\n                get() {\r\n                    let fileList = [];\r\n\r\n                    if(this.form.delivery) {\r\n                        this.nodeList.map((node, nodeIdx) => {\r\n                            node.fileList.map((file, fileIdx) => {\r\n                                file.nodeIdx = nodeIdx;\r\n                                file.fileIdx = fileIdx;\r\n                                fileList.push(file);\r\n                            });\r\n                        });\r\n                    } else {\r\n                        //debugger\r\n                        fileList.push(...this.specialFileList);\r\n                    }\r\n\r\n                    return fileList;\r\n                },\r\n                set(value) {\r\n                    console.warn(value)\r\n                },\r\n            },\r\n            getFileBadge: function() {\r\n                return (rawName) => {\r\n                    return rawName + (this.totalNum > 0 ? '<el-badge value=\"' + this.totalNum + '\" class=\"large-btn\"  />' : '');\r\n                };\r\n            },\r\n        },\r\n        watch: {\r\n            //nodeList: {\r\n            // immediate: true,\r\n            // //deep: true,\r\n            // handler(nodeList) {\r\n            //\r\n            // }\r\n            //},\r\n        },\r\n        mounted() {\r\n            this.initNodeList();\r\n\r\n            console.log(iconv.encodingExists('windows-1252'));\r\n        },\r\n\r\n        methods: {\r\n            combineFile() {\r\n                this.$refs['form'].validate((valid) => {\r\n                    if (!valid) {\r\n                        return false;\r\n                    }\r\n\r\n                    let rawList = [];\r\n                    let rawIds = [];\r\n                    this.nodeList.map(node => {\r\n                        node.fileList.map(file => {\r\n                            rawIds.push(file.id);\r\n                            rawList.push(file);\r\n                        });\r\n                    });\r\n\r\n                    rawList.push(...this.specialFileList);\r\n\r\n                    if(this.dragList.length != rawList.length) {\r\n                        this.dragList = rawList;\r\n                    }\r\n\r\n                    if(this.dragList.length == 0) {\r\n                        this.$message.info('请上传要合并的文件');\r\n                        return false;\r\n                    }\r\n\r\n                    let promiseList = [];\r\n                    this.dragList.map(file => {\r\n                        //debugger\r\n                        if(this.form.delivery && rawIds.indexOf(file.id) == -1) {\r\n                            return false;\r\n                        }\r\n\r\n                        if(!this.form.delivery && rawIds.indexOf(file.id) != -1) {\r\n                            return false;\r\n                        }\r\n\r\n                        let p = this.readFile(file, res => {\r\n                            res = res.split(\"\\n\").filter(res => res);\r\n                            res.splice(0, file.headerDeleteLine);\r\n                            res.splice(res.length - file.footerDeleteLine, file.footerDeleteLine);\r\n                            return res.join(\"\\n\");\r\n                        });\r\n\r\n                        promiseList.push(p);\r\n                    });\r\n\r\n                    if(promiseList.length == 0) {\r\n                        this.$message.info('请上传文件');\r\n                        return false;\r\n                    }\r\n\r\n                    this.form.ready = false;\r\n                    Promise.all([...promiseList]).then(res => {\r\n                        console.log(res)\r\n                        res.unshift(this.form.fileHeader);\r\n                        res.push(this.form.fileFooter);\r\n                        res = res.filter(res => res);\r\n                        res = res.join(\"\\n\");\r\n\r\n                        console.log(res)\r\n                        this.form.ready = true;\r\n                        this.downloadFileByContent(res, this.form.fileName + this.form.fileSuffix);\r\n                        this.$message.success(\"合并成功，文件：\" + this.form.fileName + this.form.fileSuffix);\r\n                    });\r\n\r\n                    console.log('content')\r\n                });\r\n            },\r\n\r\n            test(flag) {\r\n                return new Promise((resolve, reject) => {\r\n                    let time = Math.ceil(Math.random() * 10000);\r\n                    console.warn('执行 ' + flag);\r\n                    setTimeout(() => {\r\n                        resolve(time + '-' + flag);\r\n                    }, time);\r\n                });\r\n            },\r\n\r\n            readFile(file, callback) {\r\n                return new Promise((resolve, reject) => {\r\n                    let fileReader = new FileReader();\r\n                    fileReader.onloadend =  (event) => {\r\n                        console.warn(event)\r\n                        console.warn(this.detectCharset(event.target.result))\r\n                        resolve(callback(this.fileContentDecode(event.target.result)));\r\n                    };\r\n\r\n                    fileReader.readAsBinaryString(file.raw);\r\n                });\r\n            },\r\n            fileConfigAdd() {\r\n                this.dispatchFileConfig(true);\r\n            },\r\n\r\n            fileConfigReduce() {\r\n                this.dispatchFileConfig(false);\r\n            },\r\n\r\n            dispatchFileConfig(isAdd = true) {\r\n                if(this.form.delivery) {\r\n                    this.nodeList.map(node => {\r\n                        node.fileList.map(file => {\r\n                            this.doUpdateDeletedLine(file, isAdd);\r\n                        });\r\n                    });\r\n                } else {\r\n                    this.specialFileList.map(file => {\r\n                        this.doUpdateDeletedLine(file, isAdd);\r\n                    });\r\n                }\r\n            },\r\n\r\n            doUpdateDeletedLine(file, isAdd = true) {\r\n                let key = this.dragConfig.optionVal == 0 ? 'headerDeleteLine' : 'footerDeleteLine';\r\n                file[key] = file[key] == undefined ? 0 : file[key];\r\n                if(isAdd) {\r\n                    file[key] += this.dragConfig.setVal;\r\n                } else {\r\n                    file[key] -= this.dragConfig.setVal;\r\n                }\r\n\r\n                file[key] = file[key] < 0 ? 0 : file[key];\r\n                this.updateDeletedLine(file.id, key, file[key]);\r\n            },\r\n\r\n            updateDeletedLine(id, mode, value) {\r\n                let key = this.createDeleteKey(id, mode);\r\n                this.$refs[key].setCurrentValue(value);\r\n            },\r\n\r\n            dragChange(log) {\r\n                this.dragList = log.list;\r\n                console.log(log)\r\n\r\n            },\r\n            formReset() {\r\n                this.$refs.form.resetFields();\r\n                for(let key in this.form) {\r\n                    if(key == 'fileSuffixOptions') {\r\n                        continue;\r\n                    }\r\n\r\n                    if(this.form.hasOwnProperty(key)) {\r\n                        this.form[key] = key == 'ready' || key == \"delivery\" ? true : '';\r\n                    }\r\n                }\r\n            },\r\n            removeHandle(event){\r\n                console.log(event);\r\n                this.$message.success(`从 ${event.from.id} 移动到 ${event.to.id} `);\r\n            },\r\n            addNode() {\r\n                this.nodeList.push(this.initNode());\r\n            },\r\n\r\n            batchReplace() {\r\n                this.nodeList.map((node, idx) => {\r\n                    this.doReplace(idx);\r\n                });\r\n            },\r\n\r\n            batchDownload() {\r\n                this.nodeList.map((node, idx) => {\r\n                    this.downloadFile(idx);\r\n                });\r\n            },\r\n\r\n            getReplaceHis(idx) {\r\n                if(this.nodeList[idx].replaceHis.length == 0) {\r\n                    this.$message.info('没有替换历史');\r\n                    return false;\r\n                }\r\n\r\n                let hisHtml = '';\r\n                this.nodeList[idx].replaceHis.map((his, key) => {\r\n                    hisHtml += `<p>#${key} ${his}<p>`;\r\n                });\r\n\r\n                this.$alert(hisHtml, '替换历史', {\r\n                    dangerouslyUseHTMLString: true\r\n                });\r\n            },\r\n\r\n            doReplace(idx) {\r\n\r\n                if(this.nodeList[idx].fileList.length == 0) {\r\n                    this.$message.info(\"请先上传文件！\");\r\n                    return false;\r\n                }\r\n\r\n                let node = this.nodeList[idx];\r\n                let replaceKey = this.createReplaceKey(node.search, node.replace);\r\n                node.replaceHis.push(replaceKey);\r\n\r\n                let promiseList = [];\r\n                node.fileList.map(file => {\r\n                    let p = this.readFile(file, res => {\r\n                        res = res.replaceAll(node.search, node.replace);\r\n                        file.raw = new File([res], file.name, {\r\n                            name: file.name,\r\n                            size: res.length,\r\n                            type: file.type,\r\n                            lastModified: file.lastModified,\r\n                        });\r\n\r\n                        this.$message({\r\n                            message: file.name + ' 替换成功',\r\n                            type: 'success'\r\n                        });\r\n\r\n                        return res;\r\n                    });\r\n\r\n                    promiseList.push(p);\r\n                });\r\n\r\n                Promise.all([...promiseList]).then(res => {\r\n                    console.log('replace res: ', res);\r\n                });\r\n            },\r\n\r\n            fileContentDecode(binaryStr) {\r\n                return iconv.decode(binaryStr, this.detectCharset(binaryStr));\r\n            },\r\n\r\n            detectCharset(binaryStr) {\r\n                let collect = jschardet.detectAll(binaryStr);\r\n                let result = '';\r\n                let confidence = 0;\r\n\r\n                for(let idx in collect) {\r\n                    if(collect[idx].confidence > confidence) {\r\n                        result = collect[idx].encoding;\r\n                        confidence = collect[idx].confidence;\r\n                    }\r\n                }\r\n\r\n                if(['TIS-620', 'windows-1252'].indexOf(result) != -1) {\r\n                    result = 'GBK';\r\n                }\r\n\r\n                console.error(collect, result);\r\n\r\n                return result;\r\n            },\r\n\r\n            downloadFileByContent(content, fileName) {\r\n               let file = new File([content], fileName, {\r\n                   type: 'text/plain',\r\n               });\r\n               console.warn(file)\r\n               this.downloadBlob(URL.createObjectURL(file), fileName);\r\n            },\r\n\r\n            downloadFile(idx) {\r\n                if(!this.nodeList.hasOwnProperty(idx)) {\r\n                    this.$message.info(\"请上传文件！\");\r\n                    return false;\r\n                }\r\n\r\n                this.nodeList[idx].fileList.map(file => {\r\n                    let url = URL.createObjectURL(file.raw);\r\n                    let name = file.name.substring(0, file.name.lastIndexOf(\".\"));\r\n                    let suffix = file.name.substring(file.name.lastIndexOf(\".\"));\r\n                    if(this.nodeList[idx].replaceHis.length > 0) {\r\n                        name += \"(\" + this.nodeList[idx].replaceHis.join(\",\") + \")\";\r\n                    }\r\n\r\n                    console.warn(file.name)\r\n                    this.downloadBlob(url, name + suffix);\r\n                });\r\n            },\r\n            initNodeList() {\r\n                for (let i = 0; i < this.nodeNum; i++) {\r\n                    this.nodeList.push(this.initNode());\r\n                }\r\n            },\r\n            initNode() {\r\n                return {\r\n                    search: '',\r\n                    replace: '',\r\n                    fileNum: 0,\r\n                    fileList: [\r\n                        //{name: \"test.json\", uid: 55555, id:1}\r\n                    ],\r\n                    isReplace: false,\r\n                    replaceHis: [],\r\n                };\r\n            },\r\n            handleClick(tab, event) {\r\n                console.log(tab, event);\r\n            },\r\n\r\n            handleRemove(idx) {\r\n                return (file, fileList) => {\r\n                    console.log(file, fileList)\r\n                    for(var key in fileList) {\r\n                        if(file.name == fileList[key].name) {\r\n                            return false;\r\n                        }\r\n                    }\r\n\r\n                    if(idx == this.specialKey) {\r\n                        this.specialFileList = fileList;\r\n                    } else {\r\n                        this.nodeList[idx].fileNum--;\r\n                        this.nodeList[idx].fileList = fileList;\r\n\r\n                        if(fileList.length == 0) {\r\n                            this.nodeList[idx].replaceHis = [];\r\n                        }\r\n                    }\r\n\r\n                    let nameIdx = this.tmpFileNames[idx].indexOf(file.name);\r\n                    delete this.tmpFileNames[idx][nameIdx];\r\n                };\r\n            },\r\n\r\n            handlePreview(file) {\r\n                console.log(file);\r\n            },\r\n            handleProgress(event, file, fileList) {\r\n                console.log(event, file);\r\n            },\r\n\r\n            myHandleChange(idx) {\r\n                return (file, fileList) => {\r\n                    if (!this.tmpFileNames.hasOwnProperty(idx)) {\r\n                        this.tmpFileNames[idx] = [];\r\n                    }\r\n\r\n                    if (this.tmpFileNames[idx].indexOf(file.name) != -1) {\r\n                        this.$message.warning(\"出现重复文件： \" + file.name + \", 取消当前上传！\");\r\n                        console.log(this.createUploadKey(idx))\r\n                        console.log(this.$refs[this.createUploadKey(idx)])\r\n\r\n                        if(idx == this.specialKey) {\r\n                            this.$refs[this.createUploadKey(idx)].handleRemove(file, file.raw);\r\n                        } else {\r\n                            this.$refs[this.createUploadKey(idx)][0].handleRemove(file, file.raw);\r\n                        }\r\n\r\n                        return false;\r\n                    }\r\n\r\n                    file.id = this.createId();\r\n                    file.headerDeleteLine = 1;\r\n                    file.footerDeleteLine = 1;\r\n\r\n                    //file.\r\n                    if(idx == this.specialKey) {\r\n                        //debugger\r\n                        this.specialFileList = fileList;\r\n                        console.log(this.specialFileList)\r\n                    } else {\r\n                        this.nodeList[idx].fileNum++;\r\n                        this.nodeList[idx].fileList = fileList;\r\n                    }\r\n\r\n                    this.tmpFileNames[idx].push(file.name);\r\n                };\r\n            },\r\n\r\n            downloadBlob(blobUrl, fileName, revokeObjectURL) {\r\n                let downloadElement = document.createElement('a');\r\n                downloadElement.href = blobUrl;\r\n                //下载后文件名\r\n                downloadElement.download = fileName;\r\n                console.log(fileName)\r\n                document.body.appendChild(downloadElement);\r\n                //点击下载\r\n                downloadElement.click();\r\n                //下载完成移除元素\r\n                document.body.removeChild(downloadElement);\r\n                if (revokeObjectURL == null || revokeObjectURL) {\r\n                    //释放掉blob对象\r\n                    window.URL.revokeObjectURL(blobUrl)\r\n                }\r\n            },\r\n\r\n            createUploadKey(idx) {\r\n                return 'upload' + idx;\r\n            },\r\n\r\n            createReplaceKey(search, replace) {\r\n                return search + ' = ' + replace;\r\n            },\r\n\r\n            createId() {\r\n                return this.curId++;\r\n            },\r\n\r\n            createDeleteKey(id, mode) {\r\n                return id + '-' + mode;\r\n            },\r\n\r\n        }\r\n    };\r\n</script>\r\n<style>\r\n    .wrap {\r\n        border: 1px solid #ebebeb;\r\n        border-radius: 3px;\r\n        transition: .2s;\r\n        padding: 10px;\r\n        margin-top: 20px;\r\n    }\r\n\r\n    .content-overflow {\r\n        height: 200px;\r\n        overflow-y: scroll;\r\n        overflow-x: hidden;\r\n    }\r\n\r\n    .content-overflow::-webkit-scrollbar{\r\n        width: 0;\r\n    }\r\n\r\n    .margin-bottom-10 {\r\n        margin-bottom: 10px;\r\n    }\r\n\r\n    .text {\r\n        font-size: 14px;\r\n    }\r\n\r\n    .item {\r\n        margin-bottom: 18px;\r\n    }\r\n\r\n    .clearfix:before,\r\n    .clearfix:after {\r\n        display: table;\r\n        content: \"\";\r\n    }\r\n\r\n    .clearfix:after {\r\n        clear: both\r\n    }\r\n\r\n    .box-card {\r\n    }\r\n\r\n    /** upload icon*/\r\n    .my-avatar-uploader {\r\n        border: 1px dashed #d9d9d9;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n        position: relative;\r\n        overflow: hidden;\r\n        text-align: center;\r\n    }\r\n\r\n    .my-avatar-uploader:hover {\r\n        border-color: #409EFF;\r\n    }\r\n\r\n    .my-avatar-uploader .avatar-uploader-icon {\r\n        font-size: 50px;\r\n        color: #8c939d;\r\n        text-align: center;\r\n        width: 50px;\r\n        height: 50px;\r\n        line-height: 210px;\r\n\r\n    }\r\n\r\n    .my-avatar-uploader .avatar {\r\n        width: 178px;\r\n        height: 178px;\r\n        display: block;\r\n    }\r\n\r\n    .upload-demo {\r\n        position: relative;\r\n    }\r\n\r\n    .upload-demo .el-upload {\r\n        position: absolute;\r\n        z-index: 99;\r\n        border: 0px !important;\r\n        background: none;\r\n        width: 100%;\r\n    }\r\n\r\n    .upload-demo .el-upload .el-upload-dragger {\r\n\r\n        border: 0px !important;\r\n        background: none;\r\n        width: 100%;\r\n        height: 100%;\r\n    }\r\n\r\n    .upload-demo .el-icon-close {\r\n        position: absolute;\r\n        z-index: 999;\r\n        display: block;\r\n    }\r\n\r\n\r\n    #app {\r\n        overflow: scroll;\r\n    }\r\n\r\n    .margin-left-3 {\r\n        margin-left: 3px;\r\n    }\r\n\r\n    .margin-left-10 {\r\n        margin-left: 10px;\r\n    }\r\n\r\n    .ml-3 {\r\n        margin-left: 3px !important;\r\n    }\r\n    .mt-10 {\r\n        margin-top: 10px;\r\n    }\r\n\r\n    .mb-3 {\r\n        margin-bottom: 3px;\r\n    }\r\n\r\n    .large-btn {\r\n        width: 100%;\r\n    }\r\n\r\n\r\n    .drag-box{\r\n        display: flex;\r\n        user-select: none;\r\n    }\r\n    .drag-box-item {\r\n        flex: 1;\r\n        background-color: #eff1f5;\r\n        margin-right: 16px;\r\n        border-radius: 6px;\r\n        border: 1px #e1e4e8 solid;\r\n    }\r\n    .item-title{\r\n        padding: 8px 8px 8px 12px;\r\n        font-size: 14px;\r\n        line-height: 1.5;\r\n        color: #24292e;\r\n        font-weight: 600;\r\n    }\r\n    .item-ul{\r\n        padding: 0 8px 8px;\r\n        max-height: 1000px;\r\n        overflow-y: scroll;\r\n    }\r\n    .item-ul::-webkit-scrollbar{\r\n        width: 0;\r\n    }\r\n\r\n    .overflow-text {\r\n        display: block;\r\n        color: #606266;\r\n        overflow: hidden;\r\n        max-width: 250px;\r\n        padding-left: 4px;\r\n        text-overflow: ellipsis;\r\n        transition: color .3s;\r\n        white-space: nowrap;\r\n        line-height: 30px;\r\n    }\r\n\r\n    .drag-list {\r\n        border: 1px #e1e4e8 solid;\r\n        padding: 10px;\r\n        margin: 5px 0 10px;\r\n        list-style: none;\r\n        background-color: #fff;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n        -webkit-transition: border .3s ease-in;\r\n        transition: border .3s ease-in;\r\n    }\r\n    .drag-list:hover {\r\n        border: 1px solid #20a0ff;\r\n    }\r\n    .drag-title {\r\n        font-weight: 400;\r\n        line-height: 25px;\r\n        margin: 10px 0;\r\n        font-size: 22px;\r\n        color: #1f2f3d;\r\n    }\r\n    .ghost-style{\r\n        display: block;\r\n        color: transparent;\r\n        border-style: dashed\r\n    }\r\n\r\n    .el-select .el-input {\r\n        width: 130px;\r\n    }\r\n\r\n    .el-message-box {\r\n        z-index: 99999;\r\n        position: relative;\r\n    }\r\n\r\n    .min-with-80 {\r\n        width: 80px;\r\n    }\r\n\r\n    .el-upload--text {\r\n        border: 0;\r\n    }\r\n\r\n</style>\r\n"]}]}